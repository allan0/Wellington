<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Essential Mini App Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>AI Challenge Quest - Wellington</title>

    <!-- Standard Meta -->
    <meta name="description" content="Spin the AI Challenge wheel, answer AI-themed questions, and earn Welly Points!">
    <meta name="keywords" content="Wellington Campus, game, spin the wheel, quiz, challenge, AI, points, general knowledge, Telegram Mini App, profile, SVG">
    <meta name="author" content="Wellington Campus">
    <meta property="og:title" content="AI Challenge Quest - Wellington Campus">
    <meta property="og:description" content="Spin the wheel, answer AI questions, earn Welly Points!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://wellingtoncampus.co/game.html"> <!-- Update -->
    <meta property="og:image" content="./wellingtoncampus.png"> <!-- Update Path -->
    <meta property="og:image:alt" content="Wellington Campus Logo">
    <link rel="icon" href="./favicon.ico" type="image/x-icon"> <!-- Update Path -->

    <!-- **Telegram Mini App Script - MUST be first script** -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #d4af37; /* Gold */
            --secondary-color: #003366; /* Dark Blue */
            --text-color: #212529;
            --bg-color: #cce5ff; /* Light Blueish */
            --accent-color: #ffffff; /* White */
            --card-bg-color: rgba(255, 255, 255, 0.9);
            --correct-color: #28a745; /* Green */
            --incorrect-color: #dc3545; /* Red */
            --shadow: 0 8px 24px rgba(0,0,0,0.1);
            --border-radius: 15px;
            --bottom-nav-bg: var(--accent-color);
            --bottom-nav-icon: #6c757d;
            --bottom-nav-active: var(--primary-color);
            /* Wheel Colors (8 segments) */
            --color1: #ffcb80; --color2: #82d5fb; --color3: #c6e2a6; --color4: #ffac92;
            --color5: #b49edc; --color6: #fff69e; --color7: #91ccfa; --color8: #f590b2;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Roboto', sans-serif; color: var(--text-color); background-color: var(--bg-color);
            background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.1)), linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.1));
            background-size: 20px 20px; font-size: 1.05rem; line-height: 1.6; margin: 0; padding: 0;
            min-height: 100vh; min-height: var(--tg-viewport-height, 100vh);
            box-sizing: border-box; overflow-x: hidden;
            padding-bottom: calc(100px + var(--tg-safe-area-inset-bottom, 0px));
            display: flex; flex-direction: column;
        }

        /* --- Header & Logo Styling --- */
        #main-header { text-align: center; margin-bottom: 1rem; position: relative; padding-top: 1rem; flex-shrink: 0; }
        #header-logo { display: block; margin: 0 auto 0.5rem auto; max-width: 100px; width: 100px; height: auto; position: relative; top: 0; left: 0; z-index: 10; cursor: pointer; transition: width 0.4s ease-in-out, max-width 0.4s ease-in-out, top 0.4s ease-in-out, left 0.4s ease-in-out, padding 0.4s ease-in-out, border-radius 0.4s ease-in-out, background-color 0.4s ease-in-out, box-shadow 0.4s ease-in-out; }
        #header-logo.logo-scrolled { position: fixed; top: 8px; left: 12px; width: 45px; max-width: 45px; height: auto; z-index: 1045; margin: 0; background-color: rgba(255, 255, 255, 0.85); padding: 4px; border-radius: 50%; box-shadow: 0 3px 8px rgba(0, 51, 102, 0.3); }
        body.logo-state-scrolled .content-wrapper { padding-top: 60px; }

        /* --- User Profile Styling --- */
        #user-profile { position: fixed; top: 8px; right: 12px; font-size: 0.85rem; color: var(--secondary-color); background-color: rgba(255, 255, 255, 0.85); padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; z-index: 1045; box-shadow: 0 2px 5px rgba(0, 51, 102, 0.2); transition: top 0.4s ease-in-out; }
        #user-avatar { display: inline-block; width: 28px; height: 28px; border-radius: 50%; margin-right: 8px; vertical-align: middle; background-color: #e9ecef; text-align: center; line-height: 28px; font-size: 18px; overflow: hidden; }
        #user-avatar img { display: block; width: 100%; height: 100%; object-fit: cover; }
        #user-name-display { font-weight: 600; margin-right: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        #welly-points { font-weight: bold; margin-left: 5px; }
        #user-profile .fa-star { margin-left: 5px; }

        /* --- Mini App Specific Adjustments --- */
        .navbar-custom { display: none; }
        .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background-color: var(--bottom-nav-bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 0.5rem 0 max(0.5rem, var(--tg-safe-area-inset-bottom, 0.5rem)); z-index: 1040; flex-shrink: 0; }

        /* --- General & Game Styles --- */
        .content-wrapper { position: relative; padding: 1rem; text-align: center; flex-grow: 1; display: flex; flex-direction: column; align-items: center; width: 100%; box-sizing: border-box; overflow-y: auto; }
        h1, h2 { font-family: 'Poppins', sans-serif; color: var(--secondary-color); margin-bottom: 0.5rem; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.3rem; }
        .content-section { width: 100%; max-width: 600px; margin: 0 auto 1.5rem auto; background-color: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); border: none; overflow: hidden; flex-shrink: 0; }
        .content-section-header { background-color: var(--secondary-color); color: var(--accent-color); font-weight: 600; border-bottom: 3px solid var(--primary-color); padding: 0.8rem 1.2rem; display: flex; align-items: center; }
        .content-section-header h2 { color: var(--accent-color); margin: 0; font-size: 1.1rem; }
        .content-section-header i { margin-right: 0.75rem; font-size: 1.1rem; color: var(--primary-color); }
        .content-section-body { padding: 1.5rem; }

        /* --- Enhanced Wheel Styles --- */
        #wheel-container {
            position: relative; width: 90vw; max-width: 320px; aspect-ratio: 1 / 1;
            margin: 1rem auto; border: 8px solid var(--secondary-color); border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3), inset 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: #eee; overflow: hidden;
             /* Faint logo background */
             background-image: url('./wellingtoncampus.png'); /* Add path to your logo */
             background-repeat: no-repeat;
             background-position: center center;
             background-size: 60%; /* Adjust size as needed */
             position: relative; /* Needed for pseudo-element overlay */
        }
        /* Overlay to make background logo faint */
         #wheel-container::before {
             content: '';
             position: absolute;
             top: 0; left: 0; right: 0; bottom: 0;
             background-color: rgba(255, 255, 255, 0.85); /* Adjust opacity (0.8 = 80% white overlay) */
             border-radius: 50%;
             z-index: 1; /* Behind SVG, above bg image */
         }

        #wheel-svg {
            display: block; width: 100%; height: 100%;
            transform-origin: center center;
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
            position: relative; z-index: 2; /* Above faint logo overlay */
        }
        #wheel-svg g#wheel-group { transform-origin: center center; }
        #wheel-svg path.wheel-segment { stroke: rgba(255, 255, 255, 0.3); stroke-width: 1; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: center center; }
        #wheel-svg path.wheel-segment.highlighted-segment { transform: scale(1.05); filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.3)); }
        /* Removed .segment-label text style */
        #wheel-svg text.segment-emoji {
            font-size: 24px; /* Larger emoji */
            text-anchor: middle; dominant-baseline: central; /* Better vertical centering */
            pointer-events: none; user-select: none;
            fill: var(--secondary-color); /* Ensure color */
            filter: drop-shadow(0px 1px 1px rgba(0,0,0,0.2)); /* Slight shadow */
        }
        /* Center decoration */
         #wheel-container::after {
              content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
              width: 40px; height: 40px; background-color: var(--secondary-color);
              border-radius: 50%; border: 5px solid var(--accent-color);
              box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 5;
         }

        #wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--primary-color); z-index: 10; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.4)); }
        #spin-button { display: inline-block; margin-top: 1rem; padding: 0.7rem 2rem; font-size: 1.1rem; font-weight: 600; color: var(--accent-color); background-color: var(--primary-color); border: none; border-radius: 50px; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4); font-family: 'Poppins', sans-serif; }
        #spin-button:hover { background-color: #b8860b; transform: translateY(-2px); }
        #spin-button:active { transform: translateY(1px); box-shadow: 0 2px 5px rgba(212, 175, 55, 0.4); }
        #spin-button:disabled { background-color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Result Display Area - now includes Spin Again / Start Quiz buttons */
        #result-area { margin-top: 1rem; padding: 0.8rem 1rem; background-color: rgba(255, 255, 255, 0.8); border-radius: var(--border-radius); min-height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid var(--primary-color); box-shadow: var(--shadow); opacity: 0; transition: opacity 0.5s ease-in-out; }
        #result-area.visible { opacity: 1; }
        #challenge-result-text { font-size: 1.1rem; font-weight: bold; color: var(--secondary-color); font-family: 'Poppins', sans-serif; margin-bottom: 0.8rem; /* Space before buttons */ }
        #result-buttons { display: flex; gap: 10px; /* Space between buttons */ }
        #spin-again-button, #start-quiz-button {
            padding: 0.5rem 1rem; font-size: 0.9rem; border-radius: 20px;
        }
         #spin-again-button { background-color: var(--secondary-color); } /* Blue for spin again */


        /* --- Full Screen Loader --- */
        #quiz-loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 51, 102, 0.85); /* Dark blue semi-transparent */
            color: var(--accent-color);
            display: none; /* Hidden initially */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 1100; /* Above everything */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #quiz-loader-overlay.visible { display: flex; opacity: 1; }
        #quiz-loader-overlay .spinner-border { width: 3rem; height: 3rem; color: var(--primary-color); }
        #quiz-loader-overlay p { margin-top: 1rem; font-size: 1.1rem; font-style: italic; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }


        /* Quiz Display Area Styles */
        #quiz-display-area { margin-top: 1.5rem; display: none; text-align: left; opacity: 0; transition: opacity 0.6s ease-out; }
        #quiz-display-area.visible { display: block; opacity: 1; }
        /* Quiz Loader removed from here, now uses overlay */
        .quiz-question-block { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px dashed #ccc; }
        .quiz-question-block:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .quiz-question-text { font-size: 1.05rem; font-weight: bold; color: var(--secondary-color); margin-bottom: 1rem; line-height: 1.4; }
        .quiz-options button { display: block; width: 100%; margin-bottom: 0.6rem; padding: 0.7rem 1rem; text-align: left; font-size: 0.95rem; background-color: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .quiz-options button:hover { background-color: #e9ecef; border-color: #adb5bd; }
        .quiz-options button.selected { background-color: var(--primary-color); border-color: #b8860b; color: white; }
        .quiz-options button.correct { background-color: var(--correct-color); border-color: #1e7e34; color: white; }
        .quiz-options button.incorrect { background-color: var(--incorrect-color); border-color: #b21f2d; color: white; }
        .quiz-options button:disabled { opacity: 0.7; cursor: not-allowed; }
        #quiz-feedback { margin-top: 1rem; font-weight: bold; min-height: 24px; text-align: center; }
        #quiz-feedback.correct { color: var(--correct-color); }
        #quiz-feedback.incorrect { color: var(--incorrect-color); }
        #submit-quiz-button, #play-again-button { margin-top: 1.5rem; display: block; margin-left: auto; margin-right: auto;}

        /* Bottom Nav Styles */
        .bottom-nav .btn { color: var(--bottom-nav-icon); background-color: transparent; border: none; padding: 0.5rem; font-size: 0.85rem; display: flex; flex-direction: column; align-items: center; transition: color 0.3s ease; text-decoration: none; }
        .bottom-nav .btn:hover, .bottom-nav .btn.active { color: var(--bottom-nav-active); }
        .bottom-nav i { font-size: 1.1rem; margin-bottom: 0.15rem; }

        /* Helper class */
        .hidden { display: none !important; }

    </style>
</head>
<body>
    <!-- User Profile Display (Top Right) -->
    <div id="user-profile">
        <span id="user-avatar">ðŸŽ“</span> <!-- Default Emoji -->
        <span id="user-name-display">Player</span>
        | <i class="fas fa-star"></i>
        <span id="welly-points">0</span>Â WP
    </div>

     <!-- Header with Logo -->
     <header id="main-header">
        <img src="./wellingtoncampus.png" alt="Wellington Campus Logo" id="header-logo">
     </header>

    <!-- Main Content -->
    <div class="content-wrapper">

        <!-- Wheel Section (Card Structure) -->
        <section id="wheel-section" class="content-section">
             <div class="content-section-header">
                 <h2><i class="fas fa-dice"></i> AI Challenge Quest</h2>
             </div>
             <div class="content-section-body">
                 <p class="lead mb-2 small text-center">Spin for an AI challenge theme!</p>
                 <div id="wheel-container">
                     <svg id="wheel-svg" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
                         <g id="wheel-group">
                             <!-- Segments and labels added here by JS -->
                         </g>
                     </svg>
                     <!-- Removed label container, now part of SVG -->
                     <div id="wheel-pointer"></div>
                 </div>
                 <button id="spin-button" class="btn-custom">Spin the Wheel!</button>
                 <!-- Result Area Now includes Spin Again / Start Quiz -->
                 <div id="result-area">
                     <div id="challenge-result-text">Spin to receive your AI challenge theme...</div>
                     <div id="result-buttons" class="mt-2 hidden"> <!-- Hidden initially -->
                         <button id="spin-again-button" class="btn btn-secondary btn-sm"><i class="fas fa-redo me-1"></i> Spin Again</button>
                         <button id="start-quiz-button" class="btn btn-primary btn-sm"><i class="fas fa-play me-1"></i> Start Quiz</button>
                     </div>
                 </div>
             </div>
        </section>

        <!-- Quiz Display Area (Card Structure, Initially Hidden) -->
        <section id="quiz-display-area" class="content-section hidden">
             <div class="content-section-header">
                 <h2 id="quiz-display-title"><i class="fas fa-question-circle"></i> AI Challenge Questions</h2>
             </div>
             <!-- Question Container -->
             <div class="content-section-body" id="quiz-questions-container">
                 <!-- Quiz questions will be loaded here -->
             </div>
             <!-- Footer for Feedback/Buttons -->
             <div class="content-section-body text-center border-top mt-3 pt-3">
                 <div id="quiz-feedback"></div>
                 <button id="submit-quiz-button" class="btn-custom hidden">Submit Answers</button>
                 <button id="play-again-button" class="btn-custom hidden">Spin Again</button>
             </div>
        </section>

    </div> <!-- End Content Wrapper -->

    <!-- Full Screen Loader Overlay -->
    <div id="quiz-loader-overlay">
         <div class="spinner-border" role="status">
             <span class="visually-hidden">Loading...</span>
         </div>
         <p>AI preparing your challenge questions...</p>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" aria-label="Mobile navigation">
        <div class="d-flex justify-content-around w-100">
             <a href="index.html" target="_self" class="btn"><i class="fas fa-home"></i>Home</a>
             <a href="courses.html" target="_self" class="btn"><i class="fas fa-book"></i>LMS</a>
             <a href="game.html" target="_self" class="btn active"><i class="fas fa-puzzle-piece"></i>Quest</a>
             <a href="hackathon.html" target="_self" class="btn"><i class="fas fa-laptop-code"></i>Hackathon</a>
        </div>
    </nav>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const logo = document.getElementById('header-logo');
            const bodyElement = document.body;
            const wheelSVG = document.getElementById('wheel-svg');
            const wheelGroup = document.getElementById('wheel-group');
            const spinButton = document.getElementById('spin-button');
            const resultArea = document.getElementById('result-area');
            const challengeResultText = document.getElementById('challenge-result-text');
            const resultButtonsContainer = document.getElementById('result-buttons'); // New button container
            const spinAgainButton = document.getElementById('spin-again-button');
            const startQuizButton = document.getElementById('start-quiz-button');
            const wheelSection = document.getElementById('wheel-section');
            const quizDisplayArea = document.getElementById('quiz-display-area');
            const quizLoaderOverlay = document.getElementById('quiz-loader-overlay'); // Full screen loader
            const quizDisplayTitle = document.getElementById('quiz-display-title');
            const quizQuestionsContainer = document.getElementById('quiz-questions-container');
            const quizFeedback = document.getElementById('quiz-feedback');
            const submitQuizButton = document.getElementById('submit-quiz-button');
            const playAgainButton = document.getElementById('play-again-button');
            const userNameDisplay = document.getElementById('user-name-display');
            const wellyPointsDisplay = document.getElementById('welly-points');
            const userAvatarContainer = document.getElementById('user-avatar');

            // --- Telegram WebApp ---
            const tg = window.Telegram.WebApp;
            let currentUser = null;
            let totalWellyPoints = 0;

            // --- Challenges & Emojis (8 segments) ---
            const challenges = [
                 { name: "Supply Chain AI", theme: "logistics", emoji: "ðŸšš" },
                 { name: "Green AI", theme: "sustainability", emoji: "â™»ï¸" },
                 { name: "Health AI", theme: "healthcare", emoji: "âš•ï¸" },
                 { name: "Project AI", theme: "management", emoji: "ðŸ“Š" },
                 { name: "Real Estate AI", theme: "realestate", emoji: "ðŸ¢" },
                 { name: "Gov AI", theme: "government", emoji: "ðŸ›ï¸" },
                 { name: "Innovate w/ AI", theme: "open", emoji: "ðŸ’¡" },
                 { name: "AI Trivia", theme: "general", emoji: "ðŸ§ " }
            ];

             // --- AI-Focused Quiz Questions (MINIMUM 5 PER THEME) ---
             // **TODO: Add more diverse and challenging questions!**
             const quizData = {
                  logistics: [
                      { q: "AI analyzes shipping data to predict optimal container loading patterns, reducing wasted space. True or False?", o: ["True", "False"], a: 0 },
                      { q: "Which AI helps logistics companies anticipate disruptions like port closures?", o: ["Predictive Analytics", "Image Recognition", "Chatbots", "Speech Synthesis"], a: 0 },
                      { q: "An AI system identifying the fastest AND cheapest delivery route is solving a(n) ____ problem.", o: ["Classification", "Optimization", "Clustering", "Generation"], a: 1 },
                      { q: "Using computer vision AI to automatically scan package labels in sorting hubs improves?", o: ["Driver Morale", "Efficiency & Accuracy", "Fuel Economy", "Building Security"], a: 1 },
                      { q: "AI predicting future fuel price fluctuations helps logistics companies manage?", o: ["Inventory Levels", "Employee Schedules", "Operating Costs", "Marketing Campaigns"], a: 2 }
                  ],
                  sustainability: [
                      { q: "AI algorithms optimizing power grid distribution based on renewable energy availability help reduce reliance on?", o: ["Solar Panels", "Batteries", "Fossil Fuels", "Wind Turbines"], a: 2 },
                      { q: "Precision agriculture uses AI and sensors to apply water/fertilizer only where needed, reducing?", o: ["Crop Yields", "Resource Waste", "Farm Size", "Harvest Time"], a: 1 },
                      { q: "AI analyzing consumption patterns can help individuals and companies reduce their?", o: ["Carbon Footprint", "Internet Speed", "Social Media Followers", "Favorite Colors"], a: 0 },
                      { q: "Developing new, biodegradable materials can be accelerated by AI predicting?", o: ["Material Properties", "Fashion Trends", "Stock Prices", "Weather Patterns"], a: 0 },
                      { q: "AI models tracking illegal deforestation or fishing activities primarily use data from?", o: ["Newspapers", "Satellites & Drones", "Social Media", "Cookbooks"], a: 1 }
                  ],
                  healthcare: [
                       { q: "AI analyzing patient records can identify individuals at high risk for certain diseases, enabling?", o: ["Higher Insurance Premiums", "Early Intervention", "Guaranteed Cures", "Longer Wait Times"], a: 1 },
                       { q: "Robotic surgery systems guided by AI can potentially improve?", o: ["Procedure Precision", "Hospital Food Quality", "Parking Availability", "Recovery Time (by days)", "Both A & D"], a: 4 },
                       { q: "AI virtual assistants can help patients manage medication schedules and provide?", o: ["Surgical Advice", "Personalized Health Info", "Financial Loans", "Gourmet Recipes"], a: 1 },
                       { q: "Identifying novel drug candidates from vast chemical libraries is a task well-suited for?", o: ["Manual Searching", "Machine Learning", "Basic Calculators", "Patient Interviews"], a: 1 },
                       { q: "A major ethical consideration for AI in healthcare is preventing?", o: ["Algorithmic Bias", "Faster Diagnoses", "Lower Costs", "Improved Outcomes"], a: 0 }
                  ],
                   management: [
                       { q: "AI tools analyzing past project data can provide more accurate estimations for?", o: ["Team Lunch Preferences", "Future Project Timelines & Budgets", "Office Decor", "Competitor Stock Prices"], a: 1 },
                       { q: "Natural Language Processing (NLP) can analyze project meeting transcripts to identify?", o: ["Action Items & Key Decisions", "The Best Jokes", "Typing Speed", "Software Bugs Mentioned"], a: 0 }, // D is plausible but A is primary
                       { q: "AI can help assign tasks to team members based on their?", o: ["Hair Color", "Skills & Availability", "Favorite Music Genre", "Distance from Office"], a: 1 },
                       { q: "An AI 'risk assessment' tool in project management aims to highlight potential?", o: ["Success Stories", "Problems Before They Occur", "Team Achievements", "Budget Surpluses"], a: 1 },
                       { q: "Using AI to automate status report generation frees up project managers for more?", o: ["Coffee Breaks", "Strategic Thinking & Problem Solving", "Manual Data Entry", "Vacation Planning"], a: 1 }
                   ],
                   realestate: [
                       { q: "AI algorithms analyzing neighborhood data (crime rates, schools, amenities) contribute to more accurate?", o: ["Weather Forecasts", "Property Valuations", "Restaurant Menus", "Fashion Advice"], a: 1 },
                       { q: "AI-powered chatbots on property portals can pre-qualify leads by asking initial questions about?", o: ["Favorite Colors", "Budget & Requirements", "Dream Vacation", "Pet Names"], a: 1 },
                       { q: "Computer vision AI can analyze property photos/videos to automatically identify?", o: ["Potential Buyers", "Key Features & Room Types", "Hidden Treasure", "Nearby Parks"], a: 1 },
                       { q: "AI analyzing market sentiment (news, social media) can predict shifts in?", o: ["Building Materials", "Property Demand & Prices", "Interior Design Trends", "Commute Times"], a: 1 },
                       { q: "Optimizing building energy usage with AI falls under the category of?", o: ["Property Marketing", "Smart Building Management", "Tenant Screening", "Virtual Staging"], a: 1 }
                   ],
                   government: [
                       { q: "AI analyzing citizen feedback from multiple channels (email, social media) can help governments identify?", o: ["Popular Memes", "Public Service Improvement Areas", "Weather Patterns", "Stock Market Tips"], a: 1 },
                       { q: "Using AI for predictive policing is controversial due to concerns about?", o: ["Accuracy", "Bias & Civil Liberties", "Cost Savings", "Computational Speed"], a: 1 },
                       { q: "AI can help streamline the application process for permits or benefits by?", o: ["Making Forms Longer", "Automating Eligibility Checks & Routing", "Requiring In-Person Visits", "Using Morse Code"], a: 1 },
                       { q: "Analyzing public health data with AI can help predict and track?", o: ["Fashion Trends", "Disease Outbreaks", "Election Results", "Movie Preferences"], a: 1 },
                       { q: "An AI system translating laws into plain language improves?", o: ["Legal Complexity", "Citizen Understanding & Access", "Lawyer Job Security", "Judicial Speed"], a: 1 }
                   ],
                   open: [
                       { q: "AI analyzing open climate datasets can help researchers model?", o: ["Next Season's Fashion", "Future Climate Scenarios", "Stock Market Performance", "Traffic Congestion"], a: 1 },
                       { q: "Using AI to match open innovation challenges with potential solvers relies on understanding?", o: ["Solver Locations", "Problem Details & Solver Expertise", "Company Logos", "Website Colors"], a: 1 },
                       { q: "AI summarizing open access research helps overcome the challenge of?", o: ["Too Few Publications", "Information Overload", "Lack of Funding", "Slow Internet"], a: 1 },
                       { q: "Analyzing contributions to open-source software projects with AI can reveal?", o: ["Developer Locations", "Code Quality Trends & Bug Hotspots", "Favorite Programming Fonts", "Project Budget"], a: 1 },
                       { q: "An 'open' AI model refers to a model whose?", o: ["Predictions are always correct", "Architecture & Code are publicly available", "Use is restricted", "Training data is secret"], a: 1 }
                   ],
                   general: [ // AI Trivia / General Knowledge
                       { q: "What does the 'Turing Test' evaluate in AI?", o: ["Computational Speed", "Ability to Exhibit Human-like Intelligence", "Energy Efficiency", "Artistic Skill"], a: 1 },
                       { q: "Deep Blue was a famous AI that defeated a world champion in which game?", o: ["Go", "Poker", "Chess", "Checkers"], a: 2 },
                       { q: "Which tech giant developed the AI assistant 'Alexa'?", o: ["Google", "Apple", "Microsoft", "Amazon"], a: 3 },
                       { q: "Reinforcement Learning in AI involves training agents through?", o: ["Reading Books", "Rewards & Punishments", "Watching Videos", "Direct Instruction"], a: 1 },
                       { q: "The term 'Singularity' in AI discussions often refers to a hypothetical point where?", o: ["AI Debugging Ends", "AI Surpasses Human Intelligence", "All Computers Connect", "Robots Take Vacations"], a: 1 }
                  ]
             };


            // --- Game State ---
            const numSegments = challenges.length;
            const anglePerSegment = 360 / numSegments;
            const wheelRadius = 100; // SVG viewBox units
            const emojiRadius = wheelRadius * 0.70; // Position emojis inwards slightly
            let isSpinning = false;
            let currentRotation = 0;
            let currentChallenge = null;
            let currentQuizSet = [];
            let userSelections = {};
            let quizSubmitted = false;

            // --- Initialization ---
            function initializeApp() {
                 createWheelSVG();
                 setupTelegramIntegration();
                 setupLogoScroll();
                 setupButtonListeners(); // Setup listeners for new buttons
                 resetUI();
            }

            // --- SVG Wheel Generation ---
            function createWheelSVG() {
                 if (!wheelGroup) { console.error("SVG group not found!"); return; }
                 wheelGroup.innerHTML = '';
                 const center = wheelRadius;

                 challenges.forEach((challenge, index) => {
                     const startAngle = index * anglePerSegment;
                     const endAngle = startAngle + anglePerSegment;
                     const colorVar = `var(--color${(index % 8) + 1})`;

                     // Segment Path
                     const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                     path.setAttribute("d", describeArc(center, center, center - 1, startAngle, endAngle)); // Slightly smaller radius for stroke visibility
                     path.setAttribute("fill", colorVar);
                     path.setAttribute("id", `segment-${index}`);
                     path.classList.add('wheel-segment');
                     wheelGroup.appendChild(path);

                     // Emoji Position
                     const midAngle = startAngle + anglePerSegment / 2;
                     const midAngleRad = midAngle * (Math.PI / 180);
                     const emojiX = center + emojiRadius * Math.cos(midAngleRad - Math.PI / 2);
                     const emojiY = center + emojiRadius * Math.sin(midAngleRad - Math.PI / 2);

                     // Emoji Text Element
                     const emojiText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                     emojiText.setAttribute("x", emojiX);
                     emojiText.setAttribute("y", emojiY);
                     // No rotation needed if centered like this
                     // emojiText.setAttribute("transform", `rotate(${midAngle}, ${emojiX}, ${emojiY})`);
                     emojiText.classList.add("segment-emoji");
                     emojiText.textContent = challenge.emoji;
                     wheelGroup.appendChild(emojiText);
                 });
            }

            // Helper function for SVG arc path
            function describeArc(x, y, radius, startAngle, endAngle) {
                const startRad = (startAngle - 90) * Math.PI / 180;
                const endRad = (endAngle - 90) * Math.PI / 180;
                const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
                const startX = x + radius * Math.cos(startRad);
                const startY = y + radius * Math.sin(startRad);
                const endX = x + radius * Math.cos(endRad);
                const endY = y + radius * Math.sin(endRad);
                const d = ["M", startX, startY, "A", radius, radius, 0, largeArcFlag, 1, endX, endY, "L", x, y, "Z"].join(" ");
                return d;
            }

             // --- Telegram & Profile Logic (using CloudStorage) ---
            function setupTelegramIntegration() {
                 if (tg && tg.initDataUnsafe) {
                     tg.ready(); tg.BackButton.show();
                     tg.onEvent('backButtonClicked', handleBackButton);
                     currentUser = tg.initDataUnsafe.user;
                     updateUserProfileDisplay();
                     loadWellyPoints(); // Load points on init
                 } else {
                     console.warn("Not running in Telegram context.");
                     const profileElement = document.getElementById('user-profile');
                     if(profileElement) profileElement.style.display = 'none';
                     updateWellyPointsDisplay(); // Show 0 if no CS
                 }
            }
            function handleBackButton() { if (!quizDisplayArea.classList.contains('hidden')) { resetToWheelView(); } else if (window.history.length > 1) { window.history.back(); } else if (tg && tg.close) { tg.close(); } }
            function updateUserProfileDisplay() { if (!currentUser) { if(userNameDisplay) userNameDisplay.textContent = 'Guest'; if(userAvatarContainer) userAvatarContainer.textContent = 'ðŸ‘¤'; return; }; if (userNameDisplay) userNameDisplay.textContent = currentUser.first_name || 'Player'; if (userAvatarContainer) { userAvatarContainer.innerHTML = ''; if (currentUser.photo_url) { const img = document.createElement('img'); img.src = currentUser.photo_url; img.alt = `Profile photo`; userAvatarContainer.appendChild(img); } else { userAvatarContainer.textContent = 'ðŸŽ“'; } } }
            function loadWellyPoints() { totalWellyPoints = 0; if (tg && tg.CloudStorage) { tg.CloudStorage.getItem('totalWellyPoints', (error, value) => { if (!error && value) { totalWellyPoints = parseInt(value, 10) || 0; } else { totalWellyPoints = 0; if(error) console.error("CS Load Error:", error); } updateWellyPointsDisplay(); console.log("Loaded WP:", totalWellyPoints); }); } else { updateWellyPointsDisplay(); } }
            function updateWellyPointsDisplay() { if (wellyPointsDisplay) { wellyPointsDisplay.textContent = totalWellyPoints; } }
            function saveWellyPoints() { console.log("Attempting to save WP:", totalWellyPoints); if (tg && tg.CloudStorage) { tg.CloudStorage.setItem('totalWellyPoints', totalWellyPoints.toString(), (error, success) => { if (error) console.error('CS Save Error:', error); else if (!success) console.warn('CS Save returned false.'); else console.log('CS Points Saved.'); }); } else { console.warn("CloudStorage not available."); } }

            // --- Logo Scroll Logic ---
            function setupLogoScroll() { if (logo) { const handleScroll = () => { const isScrolled = window.scrollY > 30; logo.classList.toggle('logo-scrolled', isScrolled); bodyElement.classList.toggle('logo-state-scrolled', isScrolled); }; logo.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }); window.addEventListener('scroll', handleScroll, { passive: true }); handleScroll(); } }

            // --- Button Listeners ---
            function setupButtonListeners() {
                spinButton.addEventListener('click', () => { if (!isSpinning) startSpin(); });
                spinAgainButton.addEventListener('click', handleSpinAgain);
                startQuizButton.addEventListener('click', handleStartQuiz);
                submitQuizButton.addEventListener('click', handleSubmitQuiz);
                playAgainButton.addEventListener('click', resetToWheelView);
            }

            function resetUI() {
                challengeResultText.textContent = 'Spin for your AI challenge theme...';
                resultArea.classList.add('visible');
                resultButtonsContainer.classList.add('hidden'); // Hide choice buttons
                spinButton.disabled = false;
                spinButton.classList.remove('hidden');
                quizDisplayArea.classList.add('hidden');
                quizDisplayArea.classList.remove('visible');
                quizLoaderOverlay.classList.remove('visible'); // Ensure loader hidden
                quizQuestionsContainer.innerHTML = '';
                quizQuestionsContainer.style.display = 'none';
                submitQuizButton.classList.add('hidden');
                playAgainButton.classList.add('hidden');
                quizFeedback.textContent = '';
                quizFeedback.className = '';
                quizSubmitted = false;
                userSelections = {};
                wheelSection.classList.remove('hidden');
                wheelGroup.querySelectorAll('.highlighted-segment').forEach(el => el.classList.remove('highlighted-segment'));
            }

            // --- Wheel Logic ---
            function startSpin() {
                 isSpinning = true; spinButton.disabled = true;
                 resultArea.classList.remove('visible');
                 resultButtonsContainer.classList.add('hidden'); // Hide choice buttons
                 quizDisplayArea.classList.add('hidden');
                 quizDisplayArea.classList.remove('visible');
                 challengeResultText.textContent = 'Spinning...';
                 wheelGroup.querySelectorAll('.highlighted-segment').forEach(el => el.classList.remove('highlighted-segment'));

                 const randomExtraRotation = Math.random() * 360;
                 const spins = 5 + Math.floor(Math.random() * 3);
                 const targetRotation = currentRotation + spins * 360 + randomExtraRotation;

                 wheelSVG.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                 wheelSVG.style.transform = `rotate(${targetRotation}deg)`;
                 currentRotation = targetRotation;
                 setTimeout(handleSpinEnd, 5100);
            }

            function handleSpinEnd() {
                isSpinning = false;
                const finalEffectiveAngle = currentRotation % 360;
                const pointerAngle = (360 - finalEffectiveAngle) % 360;
                const winningIndex = Math.floor(pointerAngle / anglePerSegment);
                currentChallenge = challenges[winningIndex];

                challengeResultText.innerHTML = `Theme: <strong>${currentChallenge.emoji} ${currentChallenge.name}</strong>!`;
                resultArea.classList.add('visible');
                resultButtonsContainer.classList.remove('hidden'); // Show Spin Again / Start Quiz
                spinButton.classList.add('hidden'); // Hide main spin button

                const winningSegmentPath = wheelGroup.querySelector(`#segment-${winningIndex}`);
                if (winningSegmentPath) { winningSegmentPath.classList.add('highlighted-segment'); }
            }

             // --- New Button Handlers ---
             function handleSpinAgain() {
                  spinButton.disabled = false; // Re-enable main button
                  resultButtonsContainer.classList.add('hidden'); // Hide choice buttons
                  startSpin(); // Immediately spin again
             }

             function handleStartQuiz() {
                 resultButtonsContainer.classList.add('hidden'); // Hide choice buttons
                 // Show full-screen loader
                 quizLoaderOverlay.classList.add('visible');

                 const generationTime = 2000; // 2 seconds
                 setTimeout(() => {
                     quizLoaderOverlay.classList.remove('visible'); // Hide loader
                     displayQuizForChallenge(); // Display the quiz questions
                     // Scroll down after a very short delay to allow rendering
                     setTimeout(() => {
                         quizDisplayArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     }, 100);
                 }, generationTime);
             }

             // --- Quiz Logic ---
             function displayQuizForChallenge() {
                 if (!currentChallenge || !quizData[currentChallenge.theme]) { resetToWheelView(); return; }
                 const allQuestions = quizData[currentChallenge.theme];
                 currentQuizSet = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 5);
                 if (currentQuizSet.length === 0) { resetToWheelView(); return; }

                 quizDisplayTitle.innerHTML = `<i class="fas fa-question-circle"></i> ${currentChallenge.name} Quiz`;
                 quizQuestionsContainer.innerHTML = '';
                 quizSubmitted = false; userSelections = {};

                 currentQuizSet.forEach((qData, index) => {
                      const questionBlock = document.createElement('div');
                      questionBlock.classList.add('quiz-question-block');
                      questionBlock.dataset.qIndex = index;
                      const questionText = document.createElement('div');
                      questionText.classList.add('quiz-question-text');
                      questionText.textContent = `Q${index + 1}: ${qData.q}`;
                      const optionsDiv = document.createElement('div');
                      optionsDiv.classList.add('quiz-options');
                      qData.o.forEach((option, optionIndex) => {
                          const button = document.createElement('button');
                          button.textContent = option;
                          button.dataset.index = optionIndex;
                          button.addEventListener('click', () => handleOptionSelect(index, optionIndex, button));
                          optionsDiv.appendChild(button);
                      });
                      questionBlock.appendChild(questionText);
                      questionBlock.appendChild(optionsDiv);
                      quizQuestionsContainer.appendChild(questionBlock);
                  });

                 quizQuestionsContainer.style.display = 'block';
                 submitQuizButton.classList.remove('hidden');
                 submitQuizButton.disabled = true;
                 playAgainButton.classList.add('hidden');
                 quizFeedback.textContent = '';
                 quizDisplayArea.classList.remove('hidden'); // Show quiz card
                 quizDisplayArea.classList.add('visible'); // Trigger fade in
            }

            function handleOptionSelect(questionIndex, optionIndex, clickedButton) {
                 if (quizSubmitted) return;
                 userSelections[questionIndex] = optionIndex;
                 const questionBlock = clickedButton.closest('.quiz-question-block');
                 const optionsInBlock = questionBlock.querySelectorAll('.quiz-options button');
                 optionsInBlock.forEach(btn => btn.classList.remove('selected'));
                 clickedButton.classList.add('selected');
                 // Enable submit only when all 5 questions have answers
                 submitQuizButton.disabled = Object.keys(userSelections).length !== currentQuizSet.length;
            }

            function handleSubmitQuiz() { // Renamed function
                if (Object.keys(userSelections).length !== currentQuizSet.length) {
                    if(tg && tg.showAlert) tg.showAlert("Please answer all questions."); else alert("Please answer all questions.");
                    return;
                }
                checkAllAnswers();
            }

            function checkAllAnswers() {
                 quizSubmitted = true; let correctAnswersCount = 0;
                 currentQuizSet.forEach((qData, index) => {
                      const questionBlock = quizQuestionsContainer.querySelector(`.quiz-question-block[data-q-index="${index}"]`);
                      if (!questionBlock) return;
                      const optionsInBlock = questionBlock.querySelectorAll('.quiz-options button');
                      const correctIndex = qData.a; const selectedIndex = userSelections[index];
                      optionsInBlock.forEach((button, btnIndex) => {
                           button.disabled = true; button.classList.remove('selected');
                           if (btnIndex === correctIndex) button.classList.add('correct');
                           if (btnIndex === selectedIndex && selectedIndex !== correctIndex) button.classList.add('incorrect');
                      });
                      if (selectedIndex === correctIndex) correctAnswersCount++;
                 });
                 const pointsEarned = correctAnswersCount;
                 totalWellyPoints += pointsEarned;
                 updateWellyPointsDisplay();
                 saveWellyPoints(); // Save points to CloudStorage
                 quizFeedback.textContent = `Quiz Complete! Score: ${correctAnswersCount}/${currentQuizSet.length} (+${pointsEarned} WP)`;
                 quizFeedback.className = pointsEarned > 0 ? 'correct' : 'incorrect';
                 submitQuizButton.classList.add('hidden');
                 playAgainButton.classList.remove('hidden');
                 if (tg && tg.HapticFeedback) { if (pointsEarned === currentQuizSet.length) tg.HapticFeedback.notificationOccurred('success'); else if (pointsEarned > 0) tg.HapticFeedback.notificationOccurred('warning'); else tg.HapticFeedback.notificationOccurred('error'); }
            }

            function resetToWheelView() {
                 // Reset UI logic remains mostly the same, ensures choice buttons are hidden
                 quizDisplayArea.classList.add('hidden');
                 quizDisplayArea.classList.remove('visible');
                 wheelSection.classList.remove('hidden');
                 spinButton.classList.remove('hidden');
                 spinButton.disabled = false;
                 resultArea.classList.remove('visible'); // Hide result area briefly
                 resultButtonsContainer.classList.add('hidden'); // Hide choice buttons
                 challengeResultText.textContent = 'Spin again for a new quest!';
                 resultArea.classList.add('visible'); // Show updated text
                 currentChallenge = null;
                 quizSubmitted = false;
                 userSelections = {};
                 wheelGroup.querySelectorAll('.highlighted-segment').forEach(el => el.classList.remove('highlighted-segment'));
                 if (tg && tg.BackButton.isVisible) tg.BackButton.show();
            }

            // --- Start the app ---
            initializeApp();
        });
    </script>

</body>
</html>
