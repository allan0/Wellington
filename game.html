<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Essential Mini App Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>AI Challenge Quest - Wellington</title> <!-- Updated Title -->

    <!-- Standard Meta -->
    <meta name="description" content="Spin the AI Challenge wheel, answer AI-themed questions, and earn Welly Points!">
    <meta name="keywords" content="Wellington Campus, game, spin the wheel, quiz, challenge, AI, points, general knowledge, Telegram Mini App, profile">
    <meta name="author" content="Wellington Campus">
    <meta property="og:title" content="AI Challenge Quest - Wellington Campus">
    <meta property="og:description" content="Spin the wheel, answer AI questions, earn Welly Points!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://wellingtoncampus.co/game.html"> <!-- Update -->
    <meta property="og:image" content="./wellingtoncampus.png"> <!-- Update Path -->
    <meta property="og:image:alt" content="Wellington Campus Logo">
    <link rel="icon" href="./favicon.ico" type="image/x-icon"> <!-- Update Path -->

    <!-- **Telegram Mini App Script - MUST be first script** -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #d4af37; /* Gold */
            --secondary-color: #003366; /* Dark Blue */
            --text-color: #212529;
            --bg-color: #cce5ff; /* Light Blueish */
            --accent-color: #ffffff; /* White */
            --card-bg-color: rgba(255, 255, 255, 0.9);
            --correct-color: #28a745; /* Green */
            --incorrect-color: #dc3545; /* Red */
            --shadow: 0 8px 24px rgba(0,0,0,0.1);
            --border-radius: 15px;
            --bottom-nav-bg: var(--accent-color);
            --bottom-nav-icon: #6c757d;
            --bottom-nav-active: var(--primary-color);
            /* Wheel Colors (8 segments) */
            --color1: #ffcc80; --color2: #81d4fa; --color3: #c5e1a5; --color4: #ffab91;
            --color5: #b39ddb; --color6: #fff59d; --color7: #90caf9; --color8: #f48fb1; /* Pink */
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Roboto', sans-serif; color: var(--text-color); background-color: var(--bg-color);
            background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.1)), linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.1));
            background-size: 20px 20px; font-size: 1.05rem; line-height: 1.6; margin: 0; padding: 0;
            min-height: 100vh; min-height: var(--tg-viewport-height, 100vh);
            box-sizing: border-box; overflow-x: hidden;
            padding-bottom: calc(100px + var(--tg-safe-area-inset-bottom, 0px));
            display: flex; flex-direction: column; /* Ensure body itself can flex */
        }

        /* --- Header & Logo Styling --- */
        #main-header { text-align: center; margin-bottom: 1rem; position: relative; padding-top: 1rem; flex-shrink: 0; /* Prevent header shrinking */ }
        #header-logo { display: block; margin: 0 auto 0.5rem auto; max-width: 100px; width: 100px; height: auto; position: relative; top: 0; left: 0; z-index: 10; cursor: pointer; transition: width 0.4s ease-in-out, max-width 0.4s ease-in-out, top 0.4s ease-in-out, left 0.4s ease-in-out, padding 0.4s ease-in-out, border-radius 0.4s ease-in-out, background-color 0.4s ease-in-out, box-shadow 0.4s ease-in-out; }
        #header-logo.logo-scrolled { position: fixed; top: 8px; left: 12px; width: 45px; max-width: 45px; height: auto; z-index: 1045; margin: 0; background-color: rgba(255, 255, 255, 0.85); padding: 4px; border-radius: 50%; box-shadow: 0 3px 8px rgba(0, 51, 102, 0.3); }
        body.logo-state-scrolled .content-wrapper { padding-top: 60px; /* Add padding below fixed logo */}

        /* --- User Profile Styling --- */
        #user-profile { position: fixed; top: 8px; right: 12px; font-size: 0.85rem; color: var(--secondary-color); background-color: rgba(255, 255, 255, 0.85); padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; z-index: 1045; box-shadow: 0 2px 5px rgba(0, 51, 102, 0.2); transition: top 0.4s ease-in-out; }
        #user-avatar { display: inline-block; width: 28px; height: 28px; border-radius: 50%; margin-right: 8px; vertical-align: middle; background-color: #e9ecef; text-align: center; line-height: 28px; font-size: 18px; overflow: hidden; }
        #user-avatar img { display: block; width: 100%; height: 100%; object-fit: cover; }
        #user-name-display { font-weight: 600; margin-right: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        #welly-points { font-weight: bold; margin-left: 5px; }
        #user-profile .fa-star { margin-left: 5px; }

        /* --- Mini App Specific Adjustments --- */
        .navbar-custom { display: none; }
        .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background-color: var(--bottom-nav-bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 0.5rem 0 max(0.5rem, var(--tg-safe-area-inset-bottom, 0.5rem)); z-index: 1040; flex-shrink: 0; /* Prevent nav shrinking */ }

        /* --- General & Game Styles --- */
        .content-wrapper {
            position: relative; padding: 1rem; text-align: center;
            flex-grow: 1; /* Allow wrapper to take remaining space */
            display: flex; flex-direction: column; align-items: center;
            width: 100%; /* Ensure wrapper takes full width */
            box-sizing: border-box;
            overflow-y: auto; /* Allow scrolling if content exceeds height */
        }

        h1, h2 { font-family: 'Poppins', sans-serif; color: var(--secondary-color); margin-bottom: 0.5rem; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.3rem; }

        /* Card Structure */
        .content-section {
            width: 100%; max-width: 600px; margin: 0 auto 1.5rem auto;
            background-color: var(--card-bg-color); border-radius: var(--border-radius);
            box-shadow: var(--shadow); border: none; overflow: hidden;
            flex-shrink: 0; /* Prevent cards from shrinking */
        }
        .content-section-header { background-color: var(--secondary-color); color: var(--accent-color); font-weight: 600; border-bottom: 3px solid var(--primary-color); padding: 0.8rem 1.2rem; display: flex; align-items: center; }
        .content-section-header h2 { color: var(--accent-color); margin: 0; font-size: 1.1rem; }
        .content-section-header i { margin-right: 0.75rem; font-size: 1.1rem; color: var(--primary-color); }
        .content-section-body { padding: 1.5rem; }

        /* Wheel Styles - Adjusted */
        #wheel-container {
            position: relative; width: 300px; height: 300px; /* Slightly larger */
            margin: 1rem auto;
        }
        #spinner-wheel { /* The colored background part */
            width: 100%; height: 100%; border-radius: 50%; background-color: #eee;
            border: 6px solid var(--secondary-color); box-shadow: 0 0 15px rgba(0, 51, 102, 0.2);
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); position: relative;
        }
        /* NEW: Container for segment labels positioned over the wheel */
        #wheel-segment-labels {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Don't block clicks on wheel below */
            overflow: hidden; border-radius: 50%;
        }
        .segment-label { /* Style for the divs inside the label container */
             position: absolute;
             top: 50%; left: 50%; /* Center of the container */
             width: 50%; /* Extends to edge */
             height: 50%; /* Extends to edge */
             transform-origin: 0% 0%; /* Rotate around the true center */
             display: flex; flex-direction: column; align-items: center; justify-content: center;
             text-align: center; padding-top: 15px; /* Push content outwards */
             box-sizing: border-box; font-size: 9px; /* Even smaller */
             font-weight: 600; color: var(--secondary-color); line-height: 1.1;
             text-shadow: 0 0 2px rgba(255,255,255,0.7); /* slight glow */
             pointer-events: none;
        }
        .segment-label .emoji { font-size: 20px; display: block; margin-bottom: 1px; }

        #wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--primary-color); z-index: 10; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.4)); }
        #spinner-wheel::after { /* Center circle */ content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 35px; height: 35px; background-color: var(--secondary-color); border-radius: 50%; border: 5px solid var(--accent-color); z-index: 5; }
        #spin-button { display: inline-block; margin-top: 1rem; padding: 0.7rem 2rem; font-size: 1.1rem; font-weight: 600; color: var(--accent-color); background-color: var(--primary-color); border: none; border-radius: 50px; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4); font-family: 'Poppins', sans-serif; }
        #spin-button:hover { background-color: #b8860b; transform: translateY(-2px); }
        #spin-button:active { transform: translateY(1px); box-shadow: 0 2px 5px rgba(212, 175, 55, 0.4); }
        #spin-button:disabled { background-color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }
        #result-area { margin-top: 1rem; padding: 0.8rem 1rem; background-color: rgba(255, 255, 255, 0.8); border-radius: var(--border-radius); min-height: 40px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary-color); box-shadow: var(--shadow); opacity: 0; transition: opacity 0.5s ease-in-out; }
        #result-area.visible { opacity: 1; }
        #challenge-result-text { font-size: 1.1rem; font-weight: bold; color: var(--secondary-color); font-family: 'Poppins', sans-serif; margin: 0; }

        /* Quiz Display Area Styles */
        #quiz-display-area { margin-top: 1.5rem; display: none; text-align: left; opacity: 0; transition: opacity 0.6s ease-out; }
        #quiz-display-area.visible { display: block; opacity: 1; }
        #quiz-loader { text-align: center; padding: 2rem 0; display: none; /* Hidden initially */ }
        #quiz-loader p { margin-top: 0.8rem; color: var(--secondary-color); font-style: italic; font-size: 0.95rem; }
        .quiz-question-block { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px dashed #ccc; }
        .quiz-question-block:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .quiz-question-text { font-size: 1.05rem; font-weight: bold; color: var(--secondary-color); margin-bottom: 1rem; line-height: 1.4; }
        .quiz-options button { display: block; width: 100%; margin-bottom: 0.6rem; padding: 0.7rem 1rem; text-align: left; font-size: 0.95rem; background-color: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .quiz-options button:hover { background-color: #e9ecef; border-color: #adb5bd; }
        .quiz-options button.selected { background-color: var(--primary-color); border-color: #b8860b; color: white; }
        .quiz-options button.correct { background-color: var(--correct-color); border-color: #1e7e34; color: white; }
        .quiz-options button.incorrect { background-color: var(--incorrect-color); border-color: #b21f2d; color: white; }
        .quiz-options button:disabled { opacity: 0.7; cursor: not-allowed; }
        #quiz-feedback { margin-top: 1rem; font-weight: bold; min-height: 24px; text-align: center; }
        #quiz-feedback.correct { color: var(--correct-color); }
        #quiz-feedback.incorrect { color: var(--incorrect-color); }
        #submit-quiz-button, #play-again-button { margin-top: 1.5rem; display: block; margin-left: auto; margin-right: auto;}

        /* Bottom Nav Styles */
        .bottom-nav .btn { color: var(--bottom-nav-icon); background-color: transparent; border: none; padding: 0.5rem; font-size: 0.85rem; display: flex; flex-direction: column; align-items: center; transition: color 0.3s ease; text-decoration: none; }
        .bottom-nav .btn:hover, .bottom-nav .btn.active { color: var(--bottom-nav-active); }
        .bottom-nav i { font-size: 1.1rem; margin-bottom: 0.15rem; }

        /* Helper class */
        .hidden { display: none !important; }

    </style>
</head>
<body>
    <!-- User Profile Display (Top Right) -->
    <div id="user-profile">
        <span id="user-avatar">ðŸŽ“</span> <!-- Default Emoji -->
        <span id="user-name-display">Player</span>
        | <i class="fas fa-star"></i>
        <span id="welly-points">0</span>Â WP
    </div>

     <!-- Header with Logo -->
     <header id="main-header">
        <img src="./wellingtoncampus.png" alt="Wellington Campus Logo" id="header-logo">
     </header>

    <!-- Main Content -->
    <div class="content-wrapper">

        <!-- Wheel Section (Card Structure) -->
        <section id="wheel-section" class="content-section">
             <div class="content-section-header">
                 <h2><i class="fas fa-dice"></i> AI Challenge Quest</h2>
             </div>
             <div class="content-section-body">
                 <p class="lead mb-2 small text-center">Spin for an AI challenge theme!</p>
                 <div id="wheel-container">
                     <div id="spinner-wheel"></div>
                     <div id="wheel-segment-labels">
                         <!-- Segment labels (emoji/text) added by JS -->
                     </div>
                     <div id="wheel-pointer"></div>
                 </div>
                 <button id="spin-button" class="btn-custom">Spin the Wheel!</button>
                 <div id="result-area">
                     <div id="challenge-result-text">Spin to receive your AI challenge theme...</div>
                 </div>
             </div>
        </section>

        <!-- Quiz Display Area (Card Structure, Initially Hidden) -->
        <section id="quiz-display-area" class="content-section hidden">
             <div class="content-section-header">
                 <h2 id="quiz-display-title"><i class="fas fa-question-circle"></i> AI Challenge Questions</h2>
             </div>
             <!-- Loader -->
              <div id="quiz-loader">
                 <div class="spinner-border text-primary spinner-border-sm" role="status">
                     <span class="visually-hidden">Loading...</span>
                 </div>
                 <p>AI generating quiz questions...</p>
              </div>
             <!-- Question Container -->
             <div class="content-section-body" id="quiz-questions-container">
                 <!-- Quiz questions will be loaded here -->
             </div>
             <!-- Footer for Feedback/Buttons -->
             <div class="content-section-body text-center border-top mt-3 pt-3">
                 <div id="quiz-feedback"></div>
                 <button id="submit-quiz-button" class="btn-custom hidden">Submit Answers</button>
                 <button id="play-again-button" class="btn-custom hidden">Spin Again</button>
             </div>
        </section>

    </div> <!-- End Content Wrapper -->

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" aria-label="Mobile navigation">
        <div class="d-flex justify-content-around w-100">
             <a href="index.html" target="_self" class="btn"><i class="fas fa-home"></i>Home</a>
             <a href="courses.html" target="_self" class="btn"><i class="fas fa-book"></i>LMS</a>
             <a href="game.html" target="_self" class="btn active"><i class="fas fa-puzzle-piece"></i>Quest</a>
             <a href="hackathon.html" target="_self" class="btn"><i class="fas fa-laptop-code"></i>Hackathon</a>
        </div>
    </nav>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const logo = document.getElementById('header-logo');
            const bodyElement = document.body;
            const wheel = document.getElementById('spinner-wheel');
            const wheelSegmentLabelsContainer = document.getElementById('wheel-segment-labels'); // New container for labels
            const spinButton = document.getElementById('spin-button');
            const resultArea = document.getElementById('result-area');
            const challengeResultText = document.getElementById('challenge-result-text');
            const wheelSection = document.getElementById('wheel-section');
            const quizDisplayArea = document.getElementById('quiz-display-area');
            const quizLoader = document.getElementById('quiz-loader'); // Loader element
            const quizDisplayTitle = document.getElementById('quiz-display-title');
            const quizQuestionsContainer = document.getElementById('quiz-questions-container');
            const quizFeedback = document.getElementById('quiz-feedback');
            const submitQuizButton = document.getElementById('submit-quiz-button');
            const playAgainButton = document.getElementById('play-again-button');
            const userNameDisplay = document.getElementById('user-name-display');
            const wellyPointsDisplay = document.getElementById('welly-points');
            const userAvatarContainer = document.getElementById('user-avatar');

            // --- Telegram WebApp ---
            const tg = window.Telegram.WebApp;
            let currentUser = null;
            let totalWellyPoints = 0; // Session or CloudStorage score

            // --- Challenges & Emojis (8 segments) ---
            const challenges = [
                 { name: "Supply Chain AI", theme: "logistics", emoji: "ðŸšš" },
                 { name: "Green AI", theme: "sustainability", emoji: "â™»ï¸" },
                 { name: "Health AI", theme: "healthcare", emoji: "âš•ï¸" },
                 { name: "Project AI", theme: "management", emoji: "ðŸ“Š" },
                 { name: "Real Estate AI", theme: "realestate", emoji: "ðŸ¢" },
                 { name: "Gov AI", theme: "government", emoji: "ðŸ›ï¸" },
                 { name: "Innovate w/ AI", theme: "open", emoji: "ðŸ’¡" },
                 { name: "AI Trivia", theme: "general", emoji: "ðŸ§ " }
            ];

             // --- AI-Focused Quiz Questions (MINIMUM 5 PER THEME) ---
             // **TODO: Expand and refine these questions significantly!**
            const quizData = {
                logistics: [
                    { q: "How can AI optimize warehouse inventory placement?", o: ["Predicting stockouts", "Alphabetical sorting", "Random placement", "Manual checks"], a: 0 },
                    { q: "What AI technique is used for demand forecasting in supply chains?", o: ["Image Recognition", "Time Series Analysis", "Natural Language Processing", "Basic Arithmetic"], a: 1 },
                    { q: "AI-powered route optimization aims primarily to reduce?", o: ["Driver salaries", "Fuel consumption & time", "Vehicle color options", "Warehouse size"], a: 1 },
                    { q: "Using AI for predictive maintenance on delivery trucks helps prevent?", o: ["Speeding tickets", "Unexpected breakdowns", "Traffic jams", "Bad weather"], a: 1 },
                    { q: "How might AI improve customs clearance speed?", o: ["Manual form filling", "Automating document checks & risk assessment", "Hiring more officers", "Using slower ships"], a: 1 }
                ],
                sustainability: [
                    { q: "AI can analyze satellite imagery to monitor what environmental change?", o: ["Stock market trends", "Deforestation", "Website traffic", "Fashion styles"], a: 1 },
                    { q: "How can AI optimize energy consumption in smart buildings?", o: ["Turning lights off manually", "Adjusting HVAC based on occupancy/weather", "Installing older thermostats", "Opening windows randomly"], a: 1 },
                    { q: "What AI field helps identify recyclable materials in waste sorting?", o: ["Natural Language Processing", "Robotics", "Computer Vision", "Predictive Maintenance"], a: 2 },
                    { q: "AI models predicting extreme weather events contribute to?", o: ["Causing the events", "Better disaster preparedness", "Choosing vacation spots", "Stockpiling snacks"], a: 1 },
                    { q: "Using AI to design more efficient wind turbine blades is an example of AI for?", o: ["Marketing", "Renewable energy optimization", "Social media analysis", "Fossil fuel extraction"], a: 1 }
                ],
                healthcare: [
                     { q: "AI algorithms analyzing medical images (X-rays, CT scans) assist doctors in?", o: ["Making coffee", "Detecting anomalies (e.g., tumors)", "Scheduling appointments", "Patient billing"], a: 1 },
                     { q: "How can AI personalize treatment plans?", o: ["Using generic plans", "Analyzing patient data for tailored therapies", "Guessing medication", "Asking friends"], a: 1 },
                     { q: "AI-powered chatbots in healthcare can provide?", o: ["Surgical assistance", "Initial symptom assessment & info", "Driving ambulances", "Prescribing complex drugs"], a: 1 },
                     { q: "Drug discovery can be accelerated by AI through?", o: ["Manual lab tests only", "Predicting molecule interactions & effectiveness", "Randomly mixing chemicals", "Reading old textbooks"], a: 1 },
                     { q: "What is a challenge for AI in healthcare regarding patient data?", o: ["Having too much data", "Ensuring privacy and security (HIPAA)", "Data being too organized", "Doctors understanding computers"], a: 1 }
                ],
                 management: [
                     { q: "AI can assist project managers by predicting potential?", o: ["Team birthdays", "Project risks & delays", "Coffee breaks", "Office plant growth"], a: 1 },
                     { q: "How can AI automate repetitive project tasks?", o: ["Making tasks harder", "Generating reports & scheduling reminders", "Requiring manual input for everything", "Deleting project files"], a: 1 },
                     { q: "AI analyzing team communication patterns might help identify?", o: ["Favorite lunch spots", "Potential collaboration issues", "Keyboard types", "Software bugs unrelated to communication"], a: 1 },
                     { q: "Resource allocation in projects can be optimized by AI based on?", o: ["Guesswork", "Skill availability & task priority", "Manager's favorite color", "Alphabetical order"], a: 1 },
                     { q: "What is a limitation of AI in project management?", o: ["Understanding complex human factors", "Performing calculations", "Storing data", "Sending emails"], a: 0 }
                 ],
                 realestate: [
                     { q: "AI-powered property valuation models primarily use?", o: ["Astrology charts", "Historical sales data & features", "Owner's height", "Street name popularity"], a: 1 },
                     { q: "How can AI personalize property recommendations for buyers?", o: ["Showing random houses", "Analyzing buyer preferences & browsing history", "Based on the agent's favorite house", "Only showing expensive houses"], a: 1 },
                     { q: "AI analyzing market trends helps real estate investors make decisions about?", o: ["Paint colors", "When & where to buy/sell", "Furniture styles", "Local weather"], a: 1 },
                     { q: "Chatbots on real estate websites use AI for?", o: ["Designing buildings", "Answering common questions 24/7", "Negotiating final price", "Conducting open houses"], a: 1 },
                     { q: "Using AI for predictive maintenance in large buildings helps owners manage?", o: ["Tenant birthdays", "Repair costs & scheduling", "Building color schemes", "Parking fines"], a: 1 }
                 ],
                 government: [
                     { q: "AI can analyze traffic patterns to help city planners optimize?", o: ["Park bench locations", "Traffic light timing & flow", "Office coffee quality", "Public library hours"], a: 1 },
                     { q: "How might AI assist in detecting fraudulent benefit claims?", o: ["Approving all claims", "Analyzing data for suspicious patterns", "Manual review of every claim", "Randomly denying claims"], a: 1 },
                     { q: "AI-powered translation services can improve government communication with?", o: ["Pets", "Diverse language communities", "Stock markets", "Historical figures"], a: 1 },
                     { q: "Using AI to predict resource needs (e.g., emergency services) helps improve?", o: ["Response times & allocation", "Holiday decorations", "Office furniture budget", "Employee vacations"], a: 0 },
                     { q: "A challenge for AI in government is ensuring algorithms are free from?", o: ["Efficiency", "Bias & ensure fairness", "Usefulness", "Speed"], a: 1 }
                 ],
                 open: [
                     { q: "How can AI analyze open datasets (e.g., census data) for insights?", o: ["Ignoring the data", "Identifying trends & correlations", "Deleting the data", "Manually reading every entry"], a: 1 },
                     { q: "AI platforms can facilitate 'Open Innovation' by connecting companies with?", o: ["Internal teams only", "External problem solvers & ideas", "Competitors' secrets", "Historical archives"], a: 1 },
                     { q: "Using AI to automatically summarize open research papers helps accelerate?", o: ["Confusion", "Scientific discovery", "Coffee brewing", "Website loading"], a: 1 },
                     { q: "What AI technique helps categorize large amounts of user feedback from open forums?", o: ["Drawing pictures", "Natural Language Processing (NLP)", "Predictive Maintenance", "Route Optimization"], a: 1 },
                     { q: "AI analyzing open-source code repositories can help identify?", o: ["Popular programming languages", "Potential security vulnerabilities", "Developer's favorite snacks", "Both A & B"], a: 3 } // A & B are plausible
                 ],
                 general: [ // AI Trivia / General Knowledge
                     { q: "Who is often called the 'father of Artificial Intelligence'?", o: ["Alan Turing", "John McCarthy", "Isaac Newton", "Albert Einstein"], a: 1 }, // Turing is foundational, McCarthy coined the term
                     { q: "What does 'NLP' stand for in AI?", o: ["Neuro-Linguistic Programming", "Natural Language Processing", "Network Logic Protocol", "Non-Linear Prediction"], a: 1 },
                     { q: "A 'neural network' in AI is inspired by the structure of the?", o: ["Internet", "Human brain", "Ant colony", "Library catalog"], a: 1 },
                     { q: "What type of AI allows systems to learn from data without explicit programming?", o: ["General AI", "Symbolic AI", "Machine Learning", "Expert Systems"], a: 2 },
                     { q: "CAPTCHA tests are designed to distinguish humans from?", o: ["Animals", "AI Bots", "Children", "Experts"], a: 1 }
                 ]
             };


            // --- Game State ---
            const numSegments = challenges.length; // Now 8
            const anglePerSegment = 360 / numSegments;
            let isSpinning = false;
            let currentRotation = 0;
            let currentChallenge = null;
            let currentQuizSet = [];
            let userSelections = {};
            let quizSubmitted = false;

            // --- Initialization ---
            function initializeApp() {
                 setupWheelSegments();
                 setupTelegramIntegration();
                 setupLogoScroll(); // Add logo scroll setup
                 resetUI();
            }

            function setupWheelSegments() {
                 wheelSegmentLabelsContainer.innerHTML = ''; // Clear previous labels
                 const radius = wheel.offsetWidth / 2; // Estimate radius
                 const labelOffset = radius * 0.7; // Adjust to position labels inside segments (70% out)

                 challenges.forEach((challenge, index) => {
                     const segmentAngle = anglePerSegment;
                     // Calculate the angle for the middle of the segment
                     const midAngleRad = ((index * segmentAngle) + (segmentAngle / 2)) * (Math.PI / 180);

                     // Calculate position: start from center, move out along the angle
                     const x = labelOffset * Math.cos(midAngleRad - Math.PI / 2); // Adjust angle for coordinate system (0deg is right)
                     const y = labelOffset * Math.sin(midAngleRad - Math.PI / 2);

                     const labelDiv = document.createElement('div');
                     labelDiv.classList.add('segment-label');
                     // Position relative to the container's center
                     labelDiv.style.transform = `translate(${x}px, ${y}px) rotate(${midAngleRad * (180 / Math.PI)}deg)`;

                     const emojiSpan = document.createElement('span');
                     emojiSpan.classList.add('emoji');
                     emojiSpan.textContent = challenge.emoji;

                     const textSpan = document.createElement('span');
                     textSpan.textContent = challenge.name;

                     labelDiv.appendChild(emojiSpan);
                     labelDiv.appendChild(textSpan);
                     wheelSegmentLabelsContainer.appendChild(labelDiv); // Append to the dedicated label container
                 });

                 // Set conic gradient for the background wheel
                 const gradientColors = challenges.map((challenge, index) => {
                      const colorVar = `var(--color${(index % 8) + 1})`;
                      const startAngle = index * anglePerSegment;
                      const endAngle = (index + 1) * anglePerSegment;
                      return `${colorVar} ${startAngle}deg ${endAngle}deg`;
                 }).join(', ');
                 wheel.style.backgroundImage = `conic-gradient(${gradientColors})`;
            }

            function setupTelegramIntegration() {
                 if (tg && tg.initDataUnsafe) {
                     tg.ready();
                     tg.BackButton.show(); // Game page is not root
                     tg.onEvent('backButtonClicked', handleBackButton);
                     currentUser = tg.initDataUnsafe.user;
                     updateUserProfileDisplay();
                     loadWellyPoints();
                 } else {
                     console.warn("Not running in Telegram context.");
                     const profileElement = document.getElementById('user-profile');
                     if(profileElement) profileElement.style.display = 'none';
                 }
            }

            function setupLogoScroll() { // Encapsulate logo logic
                 if (logo) {
                     const handleScroll = () => {
                         const isScrolled = window.scrollY > 30;
                         logo.classList.toggle('logo-scrolled', isScrolled);
                         bodyElement.classList.toggle('logo-state-scrolled', isScrolled);
                     };
                     logo.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
                     window.addEventListener('scroll', handleScroll, { passive: true });
                     handleScroll();
                 }
            }


            function handleBackButton() {
                 if (!quizDisplayArea.classList.contains('hidden')) { resetToWheelView(); }
                 else if (window.history.length > 1) { window.history.back(); }
                 else { tg.close(); }
            }

             function updateUserProfileDisplay() {
                 // (Logic remains the same as previous version)
                 if (!currentUser) return;
                 if (userNameDisplay) userNameDisplay.textContent = currentUser.first_name || 'Player';
                 if (userAvatarContainer) { userAvatarContainer.innerHTML = ''; if (currentUser.photo_url) { const img = document.createElement('img'); img.src = currentUser.photo_url; img.alt = `Profile photo`; userAvatarContainer.appendChild(img); } else { userAvatarContainer.textContent = 'ðŸŽ“'; } }
             }

             function loadWellyPoints() {
                 totalWellyPoints = 0; // Default
                 if (tg && tg.CloudStorage) {
                      tg.CloudStorage.getItem('totalWellyPoints', (error, value) => {
                           if (!error && value) { totalWellyPoints = parseInt(value, 10) || 0; }
                           else { totalWellyPoints = 0; if(error) console.error("CS Load Error:", error); }
                           updateWellyPointsDisplay();
                           console.log("Loaded WP:", totalWellyPoints);
                      });
                 } else { updateWellyPointsDisplay(); } // Update display even if CS not available
             }

             function updateWellyPointsDisplay() {
                 if (wellyPointsDisplay) { wellyPointsDisplay.textContent = totalWellyPoints; }
             }

              function saveWellyPoints() {
                   console.log("Attempting to save WP:", totalWellyPoints);
                   if (tg && tg.CloudStorage) {
                       tg.CloudStorage.setItem('totalWellyPoints', totalWellyPoints.toString(), (error, success) => {
                            if (error) console.error('CS Save Error:', error);
                            else if (!success) console.warn('CS Save returned false');
                            else console.log('CS Points Saved successfully');
                       });
                   }
              }

            function resetUI() {
                challengeResultText.textContent = 'Spin for your AI challenge theme...';
                resultArea.classList.add('visible');
                spinButton.disabled = false;
                spinButton.classList.remove('hidden');
                quizDisplayArea.classList.add('hidden');
                quizDisplayArea.classList.remove('visible');
                quizLoader.style.display = 'none'; // Hide loader
                quizQuestionsContainer.innerHTML = ''; // Clear questions
                quizQuestionsContainer.style.display = 'none'; // Hide question container
                submitQuizButton.classList.add('hidden');
                playAgainButton.classList.add('hidden');
                quizFeedback.textContent = '';
                quizFeedback.className = '';
                quizSubmitted = false;
                userSelections = {};
                wheelSection.classList.remove('hidden'); // Ensure wheel section is visible
            }

            // --- Wheel Logic ---
            spinButton.addEventListener('click', () => { if (!isSpinning) startSpin(); });

            function startSpin() {
                 isSpinning = true; spinButton.disabled = true;
                 resultArea.classList.remove('visible');
                 quizDisplayArea.classList.add('hidden'); // Hide quiz during spin
                 quizDisplayArea.classList.remove('visible');
                 challengeResultText.textContent = 'Spinning...';

                 const randomExtraRotation = Math.random() * 360;
                 const spins = 5 + Math.floor(Math.random() * 3);
                 const totalRotation = spins * 360 + randomExtraRotation;
                 currentRotation += totalRotation;
                 wheel.style.transform = `rotate(${currentRotation}deg)`;
                 wheel.addEventListener('transitionend', handleSpinEnd, { once: true });
            }

            function handleSpinEnd() {
                isSpinning = false; // Allow interaction after animation (buttons appear later)
                const finalAngle = currentRotation % 360;
                const normalizedAngle = (360 - finalAngle) % 360;
                const winningIndex = Math.floor((normalizedAngle + anglePerSegment / 2) % 360 / anglePerSegment);
                currentChallenge = challenges[winningIndex];

                challengeResultText.innerHTML = `Theme: <strong>${currentChallenge.emoji} ${currentChallenge.name}</strong>!`;
                resultArea.classList.add('visible');
                spinButton.classList.add('hidden'); // Hide spin button

                // --- Start Quiz Generation Simulation ---
                quizDisplayArea.classList.remove('hidden'); // Show the card
                quizLoader.style.display = 'block'; // Show loader
                quizQuestionsContainer.style.display = 'none'; // Hide questions container
                submitQuizButton.classList.add('hidden'); // Hide buttons
                playAgainButton.classList.add('hidden');
                quizFeedback.textContent = ''; // Clear feedback

                const generationTime = 1500 + Math.random() * 1000; // Simulate 1.5-2.5 seconds
                setTimeout(() => {
                    quizLoader.style.display = 'none'; // Hide loader
                    displayQuizForChallenge(); // Now display the quiz
                     // Scroll down to the quiz section smoothly (optional)
                     // quizDisplayArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, generationTime);
                // --- End Simulation ---
            }

            // --- Quiz Logic ---
            function displayQuizForChallenge() {
                if (!currentChallenge || !quizData[currentChallenge.theme]) {
                    console.error("Cannot display quiz: Invalid challenge theme or no data.");
                    challengeResultText.textContent = "Error loading questions. Spin again!";
                    resetToWheelView(); // Go back to wheel if error
                    return;
                }

                const allQuestions = quizData[currentChallenge.theme];
                currentQuizSet = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 5); // Get 5 random

                if (currentQuizSet.length === 0) {
                    console.error("No questions found for theme:", currentChallenge.theme);
                    challengeResultText.textContent = "No questions available. Spin again!";
                     resetToWheelView();
                    return;
                }

                quizDisplayTitle.innerHTML = `<i class="fas fa-question-circle"></i> ${currentChallenge.name} Quiz`;
                quizQuestionsContainer.innerHTML = ''; // Clear previous
                quizSubmitted = false;
                userSelections = {};

                currentQuizSet.forEach((qData, index) => {
                     const questionBlock = document.createElement('div');
                     questionBlock.classList.add('quiz-question-block');
                     questionBlock.dataset.qIndex = index;

                     const questionText = document.createElement('div');
                     questionText.classList.add('quiz-question-text');
                     questionText.textContent = `Q${index + 1}: ${qData.q}`;

                     const optionsDiv = document.createElement('div');
                     optionsDiv.classList.add('quiz-options');

                     qData.o.forEach((option, optionIndex) => {
                         const button = document.createElement('button');
                         button.textContent = option;
                         button.dataset.index = optionIndex;
                         button.addEventListener('click', () => handleOptionSelect(index, optionIndex, button));
                         optionsDiv.appendChild(button);
                     });

                     questionBlock.appendChild(questionText);
                     questionBlock.appendChild(optionsDiv);
                     quizQuestionsContainer.appendChild(questionBlock);
                 });

                quizQuestionsContainer.style.display = 'block'; // Show questions container
                submitQuizButton.classList.remove('hidden'); // Show submit button
                playAgainButton.classList.add('hidden');
                quizFeedback.textContent = '';
                quizDisplayArea.classList.add('visible'); // Ensure card is visible (for animation)
            }

            function handleOptionSelect(questionIndex, optionIndex, clickedButton) {
                 if (quizSubmitted) return;
                 userSelections[questionIndex] = optionIndex;
                 const questionBlock = clickedButton.closest('.quiz-question-block');
                 const optionsInBlock = questionBlock.querySelectorAll('.quiz-options button');
                 optionsInBlock.forEach(btn => { btn.classList.remove('selected'); });
                 clickedButton.classList.add('selected');
                 submitQuizButton.disabled = Object.keys(userSelections).length !== currentQuizSet.length;
            }

            submitQuizButton.addEventListener('click', () => {
                if (Object.keys(userSelections).length !== currentQuizSet.length) {
                    if(tg) tg.showAlert("Please answer all questions."); else alert("Please answer all questions.");
                    return;
                }
                checkAllAnswers();
            });

            function checkAllAnswers() {
                 quizSubmitted = true;
                 let correctAnswersCount = 0;

                 currentQuizSet.forEach((qData, index) => {
                      const questionBlock = quizQuestionsContainer.querySelector(`.quiz-question-block[data-q-index="${index}"]`);
                      if (!questionBlock) return;
                      const optionsInBlock = questionBlock.querySelectorAll('.quiz-options button');
                      const correctIndex = qData.a;
                      const selectedIndex = userSelections[index];

                      optionsInBlock.forEach((button, btnIndex) => {
                           button.disabled = true;
                           button.classList.remove('selected');
                           if (btnIndex === correctIndex) button.classList.add('correct');
                           if (btnIndex === selectedIndex && selectedIndex !== correctIndex) button.classList.add('incorrect');
                      });
                      if (selectedIndex === correctIndex) correctAnswersCount++;
                 });

                 const pointsEarned = correctAnswersCount; // 1 point per correct
                 totalWellyPoints += pointsEarned;
                 updateWellyPointsDisplay();
                 saveWellyPoints(); // Save updated total

                 quizFeedback.textContent = `Quiz Complete! You scored ${correctAnswersCount}/${currentQuizSet.length} (+${pointsEarned} WP)`;
                 quizFeedback.className = pointsEarned > 0 ? 'correct' : 'incorrect';

                 submitQuizButton.classList.add('hidden');
                 playAgainButton.classList.remove('hidden');

                 if (tg && tg.HapticFeedback) {
                     if (pointsEarned === currentQuizSet.length) tg.HapticFeedback.notificationOccurred('success');
                     else if (pointsEarned > 0) tg.HapticFeedback.notificationOccurred('warning');
                     else tg.HapticFeedback.notificationOccurred('error');
                 }
            }

            playAgainButton.addEventListener('click', () => { resetToWheelView(); });

            function resetToWheelView() {
                 quizDisplayArea.classList.add('hidden');
                 quizDisplayArea.classList.remove('visible'); // Reset animation state
                 wheelSection.classList.remove('hidden');
                 spinButton.classList.remove('hidden');
                 spinButton.disabled = false; // Re-enable
                 resultArea.classList.remove('visible');
                 challengeResultText.textContent = 'Spin again for a new quest!';
                 resultArea.classList.add('visible');
                 currentChallenge = null;
                 quizSubmitted = false;
                 userSelections = {};
                 if (tg && tg.BackButton.isVisible) tg.BackButton.show();
            }

            // --- Start the app ---
            initializeApp();
        });
    </script>

</body>
</html>
