<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Essential Mini App Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>AI Hackathon - Wellington</title> <!-- Simplified Title -->

    <!-- Standard Meta -->
    <meta name="description" content="Agenda, Registration, Tasks, and AI Judge Simulation for the Wellington AI Hackathon. Earn Welly Points!">
    <meta name="keywords" content="Wellington Campus, Dubai CommerCity, hackathon, AI, agenda, judge, leaderboard, Telegram Mini App, profile, points, tasks, welly points, registration, teams, groups">
    <meta name="author" content="Wellington Campus & Dubai CommerCity">
    <meta property="og:title" content="Wellington AI Hackathon">
    <meta property="og:description" content="Agenda, Registration, Task Tracker with Welly Points, and AI Judge Simulation.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://allan0.github.io/Wellington/hackathons.html"> <!-- Your Actual URL -->
    <meta property="og:image" content="./wellingtoncampus.png"> <!-- Update Path -->
    <meta property="og:image:alt" content="Wellington Campus Logo">
    <link rel="icon" href="./favicon.ico" type="image/x-icon"> <!-- Update Path -->

    <!-- **Telegram Mini App Script - MUST be first script** -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@600&display=swap" rel="stylesheet">

    <style>
        /* --- Root Variables (Keep existing) --- */
        :root {
            --primary-color: #d4af37; /* Gold */
            --secondary-color: #003366; /* Dark Blue */
            --text-color: #212529;
            --bg-color: #f0f4f8; /* Lighter, cleaner background */
            --accent-color: #ffffff; /* White */
            --card-bg-color: rgba(255, 255, 255, 0.95); /* Slightly less transparent card */
            --success-color: #28a745;
            --error-color: #dc3545;
            --danger-color: #dc3545;
            --shadow: 0 6px 18px rgba(0,0,0,0.08); /* Softer shadow */
            --border-radius: 12px; /* Slightly smaller radius */
            --bottom-nav-bg: var(--accent-color);
            --bottom-nav-icon: #6c757d;
            --bottom-nav-active: var(--primary-color);
            /* --- NEW --- */
            --info-color: #0dcaf0;
            --warning-color: #ffc107;
        }

        /* --- Base Styles (Adjusted Padding) --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Roboto', sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            /* Removed complex background image for cleaner look */
            font-size: 1.0rem;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            min-height: var(--tg-viewport-height, 100vh);
            box-sizing: border-box;
            overflow-x: hidden;
            padding-bottom: calc(80px + var(--tg-safe-area-inset-bottom, 0px)); /* Adjusted padding for bottom nav */
            display: flex;
            flex-direction: column;
        }

        /* --- Header & Logo (Keep existing) --- */
        #main-header { text-align: center; margin-bottom: 1rem; position: relative; padding-top: 1rem; flex-shrink: 0; }
        #header-logo { display: block; margin: 0 auto 0.5rem auto; max-width: 100px; width: 100px; height: auto; position: relative; top: 0; left: 0; z-index: 10; cursor: pointer; transition: all 0.4s ease-in-out; }
        #header-logo.logo-scrolled { position: fixed; top: 8px; left: 12px; width: 45px; max-width: 45px; height: auto; z-index: 1045; margin: 0; background-color: rgba(255, 255, 255, 0.85); padding: 4px; border-radius: 50%; box-shadow: 0 3px 8px rgba(0, 51, 102, 0.3); }
        body.logo-state-scrolled .container { padding-top: 60px; }

        /* --- User Profile (Keep existing) --- */
        #user-profile {
            position: fixed; top: 8px; right: 12px; font-size: 0.85rem;
            color: var(--secondary-color); background-color: rgba(255, 255, 255, 0.9); /* More solid background */
            padding: 5px 12px; border-radius: 20px; display: flex; align-items: center;
            z-index: 1045; box-shadow: 0 2px 5px rgba(0, 51, 102, 0.15);
            transition: top 0.4s ease-in-out, background-color 0.2s ease;
            cursor: pointer; /* Make it clickable */
        }
        #user-profile:hover { background-color: rgba(235, 235, 235, 0.95); } /* Subtle hover */
        #user-avatar { display: inline-block; width: 28px; height: 28px; border-radius: 50%; margin-right: 8px; vertical-align: middle; background-color: #e9ecef; text-align: center; line-height: 28px; font-size: 18px; overflow: hidden; }
        #user-avatar img { display: block; width: 100%; height: 100%; object-fit: cover; }
        #user-name-display { font-weight: 600; margin-right: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        #welly-points { font-weight: bold; margin-left: 5px; }
        #user-profile .fa-star { margin-left: 5px; color: var(--primary-color); }

        /* --- Welly Points Gain Animation (Keep existing) --- */
        .welly-points-gain { position: fixed; z-index: 1100; color: var(--primary-color); font-weight: bold; font-size: 1.1rem; padding: 3px 8px; background-color: rgba(255, 255, 255, 0.9); border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); opacity: 0; transition: top 0.8s ease-out, opacity 0.8s ease-out, transform 0.8s ease-out; pointer-events: none; white-space: nowrap; transform: translateX(-50%); }

        /* --- Mini App Specific Adjustments (Keep existing) --- */
        .navbar-custom { display: none; }
        .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background-color: var(--bottom-nav-bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 0.5rem 0 max(0.5rem, var(--tg-safe-area-inset-bottom, 0px)); z-index: 1040; flex-shrink: 0; }
        .floating-button { position: fixed; width: 55px; height: 55px; font-size: 1.6rem; z-index: 1050; background-color: var(--secondary-color); color: var(--accent-color); border: 2px solid var(--primary-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0, 51, 102, 0.4); cursor: pointer; transition: all 0.3s ease; }
        .floating-button:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(0, 51, 102, 0.6); }

        /* --- Floating Button Positions (Keep existing) --- */
        #task-tracker-btn { left: 15px; bottom: calc(75px + var(--tg-safe-area-inset-bottom, 0px)); }
        #ai-judge-btn { right: 15px; bottom: calc(75px + var(--tg-safe-area-inset-bottom, 0px)); background-color: var(--primary-color); color: var(--secondary-color); border-color: var(--secondary-color); }
        #task-tracker-btn:hover { background-color: #004a8d; }
        #ai-judge-btn:hover { background-color: #b8860b; color: var(--secondary-color); }

        /* --- Main Container (Keep existing) --- */
        .container { flex-grow: 1; width: 100%; }

        /* --- Other Existing Styles (Keep mostly existing) --- */
         h1, h2, h3, h4, h5 { font-family: 'Poppins', sans-serif; color: var(--secondary-color); margin-top: 1.2rem; margin-bottom: 0.8rem; } /* Adjusted margins */
         h1 { color: var(--secondary-color); font-size: 1.8rem; }
         h1 .fa-cogs { color: var(--primary-color); }
         .hackathon-subtitle { color: var(--secondary-color); font-size: 1.1rem; font-weight: 400; margin-bottom: 1.5rem; }
         .card { border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 1.2rem; border: none; background-color: var(--card-bg-color); overflow: hidden; }
         .card-header { background-color: var(--secondary-color); color: var(--accent-color); font-weight: 600; border-bottom: 3px solid var(--primary-color); padding: 0.8rem 1.2rem; display: flex; align-items: center; justify-content: space-between; transition: background-color 0.2s ease; }
         .card-header h2 { color: var(--accent-color); margin: 0; font-size: 1.1rem; }
         .card-header i { margin-right: 0.6rem; font-size: 1rem; }
         .card-header[data-bs-toggle="collapse"] { cursor: pointer; }
         .card-header[data-bs-toggle="collapse"]:hover { background-color: #004a8d; }
         .card-header .chevron-icon { font-size: 0.9rem; transition: transform 0.3s ease; margin-left: auto; padding-left: 1rem; }
         .card-header .chevron-down { display: inline-block; }
         .card-header .chevron-up { display: none; }
         .card-header.collapsed .chevron-down { display: inline-block; }
         .card-header.collapsed .chevron-up { display: none; }
         .card-header:not(.collapsed) .chevron-down { display: none; }
         .card-header:not(.collapsed) .chevron-up { display: inline-block; transform: rotate(180deg); }
         .card-title { color: var(--secondary-color); margin-bottom: 1rem; font-size: 1.1rem; }
         .card-body { padding: 1.2rem; }
         .card-body h3 { margin-top: 0.5rem; font-size: 1.2rem; }
         .list-unstyled li, .list-group-item { margin-bottom: 0.7rem; display: flex; align-items: flex-start; line-height: 1.5; font-size: 0.95rem; }
         .list-unstyled i.fas, .list-unstyled i.fab, .list-group-item i.fas { color: var(--primary-color); margin-right: 0.8rem; width: 18px; text-align: center; flex-shrink: 0; margin-top: 0.15em; }
         #preparation .fa-check-circle { color: var(--success-color); }
         #preparation .fa-check { color: var(--primary-color); }
         #prizes .fa-trophy { color: #ffd700; }
         #prizes .fa-medal { color: #c0c0c0; }
         #prizes .fa-award { color: #cd7f32; }
         #prizes .fa-gifts { color: #f06292; }
         .checklist { padding-left: 0; list-style: none; margin-top: 1rem; }
         .checklist-item { background-color: #e9ecef; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 0.6rem; transition: all 0.3s ease; display: flex; align-items: center; line-height: 1.4; border-left: 4px solid var(--secondary-color); cursor: default; font-size: 0.9rem; }
         .modal .checklist-item { cursor: pointer; } /* Make only modal items clickable */
         .modal .checklist-item:hover { background-color: #dfe6ec; }
         .checklist-item i.fa-circle { color: var(--secondary-color); margin-right: 0.75rem; font-size: 1em; transition: transform 0.2s ease; }
         .checklist-item i.fa-check-circle { color: var(--success-color); display: none; margin-right: 0.75rem; font-size: 1em; transition: transform 0.2s ease; }
         .checklist-item.completed { background-color: #dff0d8; color: #3c763d; border-left: 4px solid var(--success-color); }
         .checklist-item.completed i.fa-circle { display: none; }
         .checklist-item.completed i.fa-check-circle { display: inline-block; transform: scale(1.1); }
        /* --- NEW: Celebration Emoji --- */
        .celebration-emoji {
            display: inline-block;
            margin-left: 10px;
            font-size: 1.2em;
            opacity: 0;
            transform: scale(0.5);
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .checklist-item.completed .celebration-emoji {
            opacity: 1;
            transform: scale(1);
        }
        .progress { height: 18px; font-size: 0.75rem; border-radius: 50px; background-color: #e9ecef; }
         .progress-bar { background-color: var(--primary-color); font-weight: bold; color: var(--accent-color); display: flex; align-items: center; justify-content: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); transition: width 0.6s ease; }
         .agenda-list { list-style: none; padding-left: 0; }
         .agenda-list li { margin-bottom: 1rem; display: flex; align-items: flex-start; }
         .agenda-time { flex: 0 0 70px; font-weight: bold; color: var(--secondary-color); display: flex; align-items: center; font-size: 0.9em; }
         .agenda-time i { margin-right: 5px; width: 15px; text-align: center;}
         .agenda-details { flex-grow: 1; margin-left: 10px; }
         .agenda-details strong { display: block; font-size: 0.95em; }
         .agenda-details p { font-size: 0.85em; margin-bottom: 0; color: #555; line-height: 1.3; }
         .agenda-speaker { flex: 0 0 100px; text-align: right; font-size: 0.8em; color: #6c757d; font-style: italic; margin-left: 10px; }
         .agenda-break { background-color: rgba(212,175,55,0.1); padding: 5px 0; border-left: 3px solid var(--primary-color); border-radius: 4px; margin-left: 5px; }
         .agenda-break .agenda-time { color: var(--primary-color); }
         #task-message-area .alert { margin-top: 1rem; padding: 0.7rem 1rem; font-size: 0.9rem; }
         #aiJudgeModal .modal-body { min-height: 300px; }
         #judgeLoader { text-align: center; padding: 2rem 0; display: none; }
         #judgeLoader p { margin-top: 0.8rem; color: var(--secondary-color); font-style: italic; font-size: 0.9rem;}
         #judgeResultsArea { display: none; }
         #judgeResultTeamName { margin-bottom: 0.5rem; color: var(--secondary-color); font-weight: bold;}
         #judgeResultAnalysis { margin-bottom: 1rem; }
         #judgeResultAnalysisList li { margin-bottom: 0.3rem; opacity: 0; transition: opacity 0.4s ease-in; padding-left: 1em; position: relative;}
         #judgeResultAnalysisList li::before { content: '‚úì'; position: absolute; left: 0; color: var(--success-color); font-weight: bold;}
         #judgeResultAnalysisList li.visible { opacity: 1; }
         #judgeResultScore { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); text-align: center; margin-top: 1rem; padding: 0.5rem; background-color: rgba(0,51,102,0.05); border-radius: 5px;}
         #leaderboardSection { margin-top: 1rem; opacity: 0; transition: opacity 0.5s ease; }
         #leaderboardSection.visible { opacity: 1; }
         #leaderboardSection .table th, #leaderboardSection .table td { padding: 0.4rem 0.5rem; vertical-align: middle;} /* Vertically align */
         .rank-badge { display: inline-block; width: 22px; height: 22px; line-height: 22px; text-align: center; border-radius: 50%; background-color: var(--primary-color); color: var(--accent-color); font-weight: bold; font-size: 0.8em; }
         #leaderboard-body tr:nth-child(1) .rank-badge { background-color: #ffd700; color: #333;}
         #leaderboard-body tr:nth-child(2) .rank-badge { background-color: #c0c0c0; color: #333;}
         #leaderboard-body tr:nth-child(3) .rank-badge { background-color: #cd7f32; color: #fff;}
         #leaderboard-body tr.highlight-new td { background-color: rgba(212, 175, 55, 0.2); transition: background-color 1s ease-out; }
         #flying-score-element { position: absolute; /* Changed from fixed for modal relative positioning */ z-index: 1100; font-size: 1.2rem; font-weight: bold; color: var(--primary-color); background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); opacity: 0; transition: top 0.6s ease-in-out, left 0.6s ease-in-out, opacity 0.6s ease-in-out, transform 0.6s ease-in-out; pointer-events: none; transform-origin: center center; }

         .bottom-nav .btn { color: var(--bottom-nav-icon); background-color: transparent; border: none; padding: 0.5rem; font-size: 0.85rem; display: flex; flex-direction: column; align-items: center; transition: color 0.3s ease; text-decoration: none; }
         .bottom-nav i { font-size: 1.1rem; margin-bottom: 0.15rem; }
         .bottom-nav .btn.active { color: var(--bottom-nav-active); font-weight: 600;}
         .task-points { font-size: 0.75rem; font-weight: bold; color: var(--accent-color); background-color: var(--primary-color); padding: 2px 6px; border-radius: 10px; margin-left: auto; margin-right: 5px; white-space: nowrap; }
         .checklist-item.completed .task-points { background-color: var(--success-color); color: var(--accent-color); }
         .btn-custom { background-color: var(--primary-color); color: var(--accent-color) !important; border: none; padding: 0.6rem 1.5rem; border-radius: 25px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(212,175,55,0.3); font-weight: 600; text-decoration: none; display: inline-block; }
         .btn-custom:hover { background-color: #b8860b; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.4); color: var(--accent-color) !important; }
         .btn-custom.btn-lg { padding: 0.8rem 2rem; font-size: 1.1rem; } /* Larger register button */

         /* --- NEW: Registration Form Specifics --- */
         #registrationForm .form-label { font-weight: 500; margin-bottom: 0.3rem; }
         #registrationFeedback { font-size: 0.9rem; min-height: 1.2em; margin-top: 0.8rem; font-weight: 500;} /* Bolder feedback */
         #team-member-count { min-height: 1.2em; margin-top: 0.25rem; font-style: italic; }
         .registration-section-divider {
             text-align: center; margin: 1rem 0; font-weight: bold; color: var(--secondary-color);
             display: flex; align-items: center;
         }
         .registration-section-divider::before, .registration-section-divider::after {
             content: ''; flex: 1; border-bottom: 1px solid #ccc; margin: 0 0.5em;
         }
         #registrationModal .modal-footer { justify-content: space-between; } /* Space out buttons */
         .form-control-sm, .form-select-sm { font-size: 0.9rem; }

         /* --- Profile Modal Specific Styles (Keep existing) --- */
         #userProfileModal .modal-header { background-color: var(--secondary-color); color: var(--accent-color); border-bottom: 3px solid var(--primary-color); }
         #userProfileModal .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
         #userProfileModal .modal-body { text-align: center; }
         #modal-user-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 0.5rem auto; display: block; background-color: #e9ecef; font-size: 40px; line-height: 80px; overflow: hidden; border: 3px solid var(--primary-color); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
         #modal-user-avatar img { width: 100%; height: 100%; object-fit: cover; }
         #modal-user-name { font-size: 1.3rem; font-weight: 600; color: var(--secondary-color); margin-bottom: 0.2rem; }
         #modal-welly-points-display { font-size: 1.8rem; font-weight: bold; color: var(--primary-color); margin-bottom: 1rem; }
         #modal-welly-points-display .fa-star { font-size: 1.5rem; margin-right: 5px; vertical-align: middle; }
         #profile-rank-display { font-size: 0.95rem; color: var(--text-color); margin-bottom: 1.5rem; background-color: rgba(0, 51, 102, 0.05); padding: 0.5rem; border-radius: 8px; border-left: 4px solid var(--secondary-color); }
         #profile-leaderboard-section h5 { color: var(--secondary-color); margin-bottom: 0.8rem; font-size: 1.1rem; }
         #profile-leaderboard-table { font-size: 0.9rem; }
         #profile-leaderboard-table thead { background-color: var(--secondary-color); color: var(--accent-color); }
         #profile-leaderboard-body tr td { vertical-align: middle; }
         #profile-leaderboard-body .rank-badge { font-weight: bold; font-size: 0.9em; color: var(--secondary-color); display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; background-color: rgba(212, 175, 55, 0.8); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
         #profile-leaderboard-body tr:nth-child(1) .rank-badge { background-color: #ffd700; color: #333; }
         #profile-leaderboard-body tr:nth-child(2) .rank-badge { background-color: #c0c0c0; color: #333; }
         #profile-leaderboard-body tr:nth-child(3) .rank-badge { background-color: #cd7f32; color: #fff; }
         #profile-leaderboard-body .points-cell { font-weight: bold; color: var(--secondary-color); text-align: right; }
         #profile-leaderboard-body tr.table-info { background-color: rgba(212, 175, 55, 0.15) !important; font-weight: bold; }
         #delete-progress-btn { background-color: var(--danger-color); border-color: var(--danger-color); color: white; transition: background-color 0.2s ease, border-color 0.2s ease; }
         #delete-progress-btn:hover { background-color: #c82333; border-color: #bd2130; }
         #delete-progress-btn:disabled { background-color: #6c757d; border-color: #6c757d; opacity: 0.65; cursor: not-allowed; } /* Added opacity */
         #leaderboard-loading, #leaderboard-empty { color: #6c757d; font-style: italic; padding: 1rem 0; text-align: center; }
         #reset-feedback { font-size: 0.85rem; margin-top: 5px; min-height: 1.2rem; font-weight: 500; text-align: left; } /* Adjusted feedback style */
         .feedback-success { color: var(--success-color); }
         .feedback-error { color: var(--danger-color); }
         .feedback-info { color: var(--info-color); }
         .feedback-warning { color: var(--warning-color); }
         .text-muted { color: #6c757d !important; }

    </style>
</head>
<body>
    <!-- User Profile Display (Top Right) -->
    <div id="user-profile" data-bs-toggle="modal" data-bs-target="#userProfileModal">
        <span id="user-avatar">üë§</span>
        <span id="user-name-display">Player</span>
        | <i class="fas fa-star"></i>
        <span id="welly-points">0</span> WP
    </div>

    <!-- Main Content Container -->
    <div class="container mt-2" id="hackathon">

        <!-- Header Section -->
        <header id="main-header">
            <img src="./wellingtoncampus.png" alt="Wellington Campus Logo" id="header-logo">
            <h1><i class="fas fa-cogs me-2"></i>AI Hackathon</h1>
            <p class="hackathon-subtitle">Day 1 @ Dubai CommerCity</p>
        </header>

        <!-- MODIFIED: Registration Button Section -->
        <section id="registration-action" class="text-center mb-4">
            <button class="btn btn-custom btn-lg" id="registerTeamBtn" data-bs-toggle="modal" data-bs-target="#registrationModal" disabled>
                <i class="fas fa-users me-2"></i> Loading...
            </button>
            <p id="registration-status-message" class="small text-muted mt-1 fst-italic"></p>
        </section>

        <!-- Progress Bar Section (Keep Existing) -->
        <section id="progress" class="mb-3 card">
             <div class="card-header"> <h2><i class="fas fa-tasks"></i>Progress & Points</h2> </div>
             <div class="card-body">
                 <p class="small mb-2">Track tasks via <i class="fas fa-tasks"></i> button & earn WP! Register your team first.</p>
                 <div class="progress" role="progressbar" aria-label="Hackathon Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                     <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                 </div>
             </div>
        </section>

        <!-- Quick Info Section (Keep Existing) -->
        <section id="quick-info" class="card mb-3">
             <div class="card-body">
                 <h3><i class="fas fa-bolt me-2"></i>Quick Info - Day 1</h3>
                 <ul class="list-unstyled">
                     <li><i class="fas fa-calendar-alt"></i> <strong>Event:</strong> Shaping Tomorrow‚Äôs Solution</li>
                     <li><i class="fas fa-calendar-day"></i> <strong>Date:</strong> Wed, Apr 23, 2025</li>
                     <li><i class="fas fa-clock"></i> <strong>Time:</strong> 08:30 - 14:00</li>
                     <li><i class="fas fa-map-marker-alt"></i> <strong>Venue:</strong> Dubai CommerCity</li>
                 </ul>
             </div>
        </section>

        <!-- Collapsible Sections (Keep existing structure) -->
        <div id="accordionHackathon">
            <!-- Agenda -->
            <section id="agenda" class="card mb-3">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseAgenda" aria-expanded="true" aria-controls="collapseAgenda"> <h2><i class="fas fa-calendar-alt"></i>Agenda</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div>
                <div class="collapse show" id="collapseAgenda" data-bs-parent="#accordionHackathon">
                    <div class="card-body">
                         <h3 class="mb-3 mt-0 small" style="color: var(--primary-color);"><i class="fas fa-flag-checkered me-2"></i>Wednesday, 23rd April 2025</h3>
                         <ul class="agenda-list">
                             <li> <span class="agenda-time"><i class="fas fa-sign-in-alt"></i>08:30</span> <span class="agenda-details"><strong>Registrations & Check-in</strong><p>Arrival, kits, team confirmation.</p></span> <span class="agenda-speaker"><small>DAFZ & Wellington</small></span> </li>
                             <li> <span class="agenda-time"><i class="fas fa-users"></i>08:45</span> <span class="agenda-details"><strong>Group Finalization</strong><p>Confirm groups or join one.</p></span> <span class="agenda-speaker"><small>Facilitated</small></span> </li>
                             <li> <span class="agenda-time"><i class="fas fa-bullhorn"></i>09:00</span> <span class="agenda-details"><strong>Opening Speech</strong><p>Kick-off.</p></span> <span class="agenda-speaker"><small>Wellington</small></span> </li>
                             <li> <span class="agenda-time"><i class="fas fa-scroll"></i>09:05</span> <span class="agenda-details"><strong>Code of Conduct</strong><p>Rules & IP.</p></span> <span class="agenda-speaker"><small>Coordinator</small></span> </li>
                             <li> <span class="agenda-time"><i class="fas fa-users"></i>09:10</span> <span class="agenda-details"><strong>Team Intros (Brief)</strong><p>Quick ice-breaker.</p></span> <span class="agenda-speaker"><small>All Teams</small></span> </li>
                             <li> <span class="agenda-time"><i class="fas fa-dice"></i>09:20</span> <span class="agenda-details"><strong>Challenge Assignment</strong><p>Spin Wheel. <a href="game.html" target="_self" class="link-secondary small">(Go to Wheel)</a></p></span> <span class="agenda-speaker"><small>Facilitated</small></span> </li>
                             <li> <span class="agenda-time"><i class="fas fa-laptop-code"></i>09:30</span> <span class="agenda-details"><strong>Hacking Begins!</strong></span> <span class="agenda-speaker">-</span> </li>
                             <li class="agenda-break"> <span class="agenda-time"><i class="fas fa-headset"></i>Ongoing</span> <span class="agenda-details"><strong>Support Active</strong><p>Mentors, Help Desk, Pitch Coach.</p></span> <span class="agenda-speaker"><small>Wellington</small></span> </li>
                             <li class="agenda-break"> <span class="agenda-time"><i class="fas fa-utensils"></i>~12:30</span> <span class="agenda-details"><strong>Lunch Break</strong></span> <span class="agenda-speaker">-</span> </li>
                             <li> <span class="agenda-time"><i class="fas fa-flag-checkered"></i>14:00</span> <span class="agenda-details"><strong>Day 1 Wrap-Up & Submit</strong><p>Submit rough model & deck draft.</p></span> <span class="agenda-speaker"><small>Via Link</small></span> </li>
                         </ul>
                    </div>
                </div>
            </section>
            <!-- Other sections (Support, Outcomes, etc. - Keep as before) -->
             <section id="support" class="card mb-3"> <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseSupport" aria-expanded="false" aria-controls="collapseSupport"> <h2><i class="fas fa-hands-helping"></i>Support</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div> <div class="collapse" id="collapseSupport" data-bs-parent="#accordionHackathon"> <div class="card-body"> <ul class="list-unstyled"> <li><i class="fas fa-chalkboard-teacher"></i> Briefing & Q&A</li> <li><i class="fas fa-user-friends"></i> Mentor Assignment</li> <li><i class="fas fa-headset"></i> Help Desk</li> <li><i class="fas fa-microphone-alt"></i> Pitch Coaching</li> <li><i class="fas fa-folder-open"></i> Resource Access</li> </ul> </div> </div> </section>
             <section id="outcomes" class="card mb-3"> <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseOutcomes" aria-expanded="false" aria-controls="collapseOutcomes"> <h2><i class="fas fa-check-double"></i>Outcomes</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div> <div class="collapse" id="collapseOutcomes" data-bs-parent="#accordionHackathon"> <div class="card-body"> <p class="small">By end of Day 1:</p> <ul class="list-unstyled"> <li><i class="fas fa-cogs text-success"></i> Rough model/logic</li> <li><i class="fas fa-file-powerpoint text-success"></i> Draft pitch deck</li> <li><i class="fas fa-upload text-success"></i> Submitted materials</li> </ul> </div> </div> </section>
             <section id="tracks" class="card mb-3"> <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseTracks" aria-expanded="false" aria-controls="collapseTracks"> <h2><i class="fas fa-stream"></i>Themes</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div> <div class="collapse" id="collapseTracks" data-bs-parent="#accordionHackathon"> <div class="card-body"> <ul class="list-unstyled"> <li><i class="fas fa-truck-loading"></i> Supply Chain</li> <li><i class="fas fa-leaf"></i> Sustainability</li> <li><i class="fas fa-briefcase-medical"></i> Healthcare</li> <li><i class="fas fa-tasks"></i> Project Mgmt</li> <li><i class="fas fa-city"></i> Real Estate</li> <li><i class="fas fa-landmark"></i> Government</li> <li><i class="fas fa-lightbulb"></i> Open Innovation</li> </ul> <p class="small text-muted mt-2">Assigned via <a href="game.html" target="_self">Spin the Wheel</a>.</p> </div> </div> </section>
             <section id="preparation" class="card mb-3"> <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapsePrep" aria-expanded="false" aria-controls="collapsePrep"> <h2><i class="fas fa-laptop-code"></i>Preparation</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div> <div class="collapse" id="collapsePrep" data-bs-parent="#accordionHackathon"> <div class="card-body"> <h5 class="card-title small"><i class="fas fa-laptop me-2"></i>Hardware</h5> <ul class="list-unstyled ps-2 small"> <li><i class="fas fa-check-circle"></i> Laptop</li> <li><i class="fas fa-check-circle"></i> Charger</li> <li><i class="fas fa-check-circle"></i> Wi-Fi @ Venue</li> </ul> <h5 class="card-title small mt-2"><i class="fas fa-tools me-2"></i>Software</h5> <ul class="list-unstyled ps-2 small"> <li><i class="fab fa-python"></i> Python 3.8+</li> <li><i class="fas fa-book"></i> Jupyter/Editor</li> <li><i class="fas fa-code-branch"></i> Git/GitHub</li> <li><i class="fas fa-brain"></i> AI Libs (Opt)</li> <li><i class="fas fa-cloud-upload-alt"></i> Cloud Acct (Opt)</li> </ul> <h5 class="card-title small mt-2"><i class="fas fa-lightbulb me-2"></i>Knowledge</h5> <ul class="list-unstyled ps-2 small"> <li><i class="fas fa-check"></i> Python Basics</li> <li><i class="fas fa-check"></i> Basic AI/ML</li> <li><i class="fas fa-check"></i> Teamwork!</li> </ul> </div> </div> </section>
             <section id="prizes" class="card mb-3"> <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapsePrizes" aria-expanded="false" aria-controls="collapsePrizes"> <h2><i class="fas fa-trophy"></i>Prizes</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div> <div class="collapse" id="collapsePrizes" data-bs-parent="#accordionHackathon"> <div class="card-body"> <ul class="list-unstyled small"> <li><i class="fas fa-trophy"></i> 1st: AED 10k, Swag, Ops</li> <li><i class="fas fa-medal"></i> 2nd: AED 5k, Swag</li> <li><i class="fas fa-award"></i> 3rd: AED 2.5k, Swag</li> <li><i class="fas fa-lightbulb"></i> Innovation Award</li> <li><i class="fas fa-gifts"></i> All: Certificate, Swag</li> <li><i class="fas fa-handshake"></i> Networking</li> </ul> </div> </div> </section>
             <section id="judging" class="card mb-3"> <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseJudging" aria-expanded="false" aria-controls="collapseJudging"> <h2><i class="fas fa-gavel"></i>Judging</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div> <div class="collapse" id="collapseJudging" data-bs-parent="#accordionHackathon"> <div class="card-body"> <p class="small">Final judging (Day 2) considers:</p> <ul class="list-unstyled small"> <li><i class="fas fa-cogs"></i> Technical</li> <li><i class="fas fa-lightbulb"></i> Innovation</li> <li><i class="fas fa-bullseye"></i> Impact</li> <li><i class="fas fa-presentation"></i> Pitch/Demo</li> <li><i class="fas fa-check-circle"></i> Completion</li> </ul> <p class="small mt-2">Note: AI Judge Sim (<i class="fas fa-gavel"></i> button) provides simulated scores for fun/practice using registered teams/groups.</p> </div> </div> </section>
             <section id="logistics-info" class="card mb-3"> <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseLogistics" aria-expanded="false" aria-controls="collapseLogistics"> <h2><i class="fas fa-building me-2"></i>Logistics</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div> <div class="collapse" id="collapseLogistics" data-bs-parent="#accordionHackathon"> <div class="card-body"> <p class="small">Venue requests:</p> <ul class="list-unstyled small"> <li><i class="fas fa-users"></i> Breakout spaces</li> <li><i class="fas fa-desktop"></i> Screen/Projector</li> <li><i class="fas fa-video"></i> Basic Recording?</li> </ul> </div> </div> </section>
             <!-- Removed Registration Note Section -->
             <section id="contact" class="card mb-3"> <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseContact" aria-expanded="false" aria-controls="collapseContact"> <h2><i class="fas fa-envelope"></i>Contact</h2> <span class="chevron-icon ms-auto"> <i class="fas fa-chevron-down chevron-down"></i><i class="fas fa-chevron-up chevron-up"></i></span> </div> <div class="collapse" id="collapseContact" data-bs-parent="#accordionHackathon"> <div class="card-body"> <div class="row small"> <div class="col-6 mb-2"> <strong>Wellington:</strong> <ul class="list-unstyled mt-1"> <li><i class="fas fa-envelope-open-text"></i> <a href="mailto:info@wellingtoncampus.co">Email</a></li> <li><i class="fas fa-phone"></i> <a href="tel:+971542523922">Call</a></li> </ul> </div> <div class="col-6 mb-2"> <strong>CommerCity:</strong> <ul class="list-unstyled mt-1"> <li><i class="fas fa-envelope-open-text"></i> Email DCC</li> <li><i class="fas fa-phone"></i> Call DCC</li> </ul> </div> </div> </div> </div> </section>
        </div> <!-- End Accordion -->

        <!-- Footer -->
        <footer class="text-center mt-4 mb-3 text-muted"> <!-- Increased top margin -->
            <small>¬© 2024-25 DCC & Wellington Campus</small>
        </footer>

    </div> <!-- End Main Container -->

    <!-- Floating Buttons -->
    <button class="floating-button" id="task-tracker-btn" title="Task Tracker" data-bs-toggle="modal" data-bs-target="#taskTrackerModal">
        <i class="fas fa-tasks"></i>
    </button>
    <button class="floating-button" id="ai-judge-btn" title="AI Judge Sim" data-bs-toggle="modal" data-bs-target="#aiJudgeModal">
        <i class="fas fa-gavel"></i>
    </button>

    <!-- Task Tracker Modal (MODIFIED Checklist) -->
    <div class="modal fade" id="taskTrackerModal" tabindex="-1" aria-labelledby="taskTrackerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskTrackerModalLabel"><i class="fas fa-tasks me-2"></i>Day 1 Tasks & Points</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Confirm completion to earn Welly Points! Must be registered first.</p>
                    <div id="task-message-area" class="mb-3"></div>
                    <div class="checklist" id="modal-checklist">
                        <!-- Tasks updated and new one added -->
                        <div class="checklist-item" data-task-id="checkin" data-points="5"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Check-in Complete</strong></div> <span class="task-points">+5 WP</span><span class="celebration-emoji">üéâ</span></div>
                        <div class="checklist-item" data-task-id="join_group" data-points="10"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Join/Confirm Group</strong> <small>(Via Register Button)</small></div> <span class="task-points">+10 WP</span><span class="celebration-emoji">ü§ù</span></div>
                        <div class="checklist-item" data-task-id="briefing" data-points="5"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Attend Briefing</strong></div> <span class="task-points">+5 WP</span><span class="celebration-emoji">üëÇ</span></div>
                        <div class="checklist-item" data-task-id="challenge" data-points="10"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Receive Challenge</strong></div> <span class="task-points">+10 WP</span><span class="celebration-emoji">üéØ</span></div>
                        <div class="checklist-item" data-task-id="brainstorm" data-points="15"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Plan Initial Approach</strong></div> <span class="task-points">+15 WP</span><span class="celebration-emoji">üí°</span></div>
                        <div class="checklist-item" data-task-id="mentor-meet" data-points="10"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Meet Mentor (Intro)</strong></div> <span class="task-points">+10 WP</span><span class="celebration-emoji">üë®‚Äçüè´</span></div>
                        <div class="checklist-item" data-task-id="logic-dev" data-points="25"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Develop Logic/Model (Draft)</strong></div> <span class="task-points">+25 WP</span><span class="celebration-emoji">üíª</span></div>
                        <div class="checklist-item" data-task-id="deck-start" data-points="15"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Start Pitch Deck (Draft)</strong></div> <span class="task-points">+15 WP</span><span class="celebration-emoji">üìä</span></div>
                        <div class="checklist-item" data-task-id="pitch-coach" data-points="10"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Pitch Coach Session (Optional)</strong></div> <span class="task-points">+10 WP</span><span class="celebration-emoji">üé§</span></div>
                        <div class="checklist-item" data-task-id="day1-submit" data-points="20"> <i class="far fa-circle"></i><i class="far fa-check-circle"></i> <div><strong>Submit Day 1 Drafts</strong></div> <span class="task-points">+20 WP</span><span class="celebration-emoji">üöÄ</span></div>
                         <!-- Total Points: 135 -->
                    </div>
                    <p class="small text-muted mt-3 fst-italic">*Points are awarded upon confirmation.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Judge Modal (MODIFIED Select Options & Leaderboard) -->
    <div class="modal fade" id="aiJudgeModal" tabindex="-1" aria-labelledby="aiJudgeModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-lg modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="aiJudgeModalLabel"><i class="fas fa-brain me-2"></i>AI Judge Sim & Groups</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p class="text-muted small">Select a team/group, click Judge for a simulated score, or view the current groups.</p>

            <!-- Judge Simulation Area -->
            <div class="border rounded p-3 mb-3 bg-light">
                <div class="row g-2 align-items-end">
                    <div class="col-sm-8">
                         <label for="judgeTeamSelect" class="form-label small fw-bold">Select Team/Group for Judging:</label>
                         <select class="form-select form-select-sm" id="judgeTeamSelect">
                             <option selected disabled value="">-- Choose Registered Team/Group --</option>
                             <!-- Options populated dynamically -->
                         </select>
                    </div>
                    <div class="col-sm-4">
                         <button class="btn btn-primary w-100 btn-sm" type="button" id="judgeProjectBtn">
                             <i class="fas fa-play me-1"></i> Judge
                         </button>
                    </div>
                </div>
                 <div id="judgeLoader" class="mt-2"> <div class="spinner-border spinner-border-sm text-primary" role="status"> <span class="visually-hidden">Loading...</span> </div> <p class="small d-inline ms-2">AI analyzing...</p> </div>
                 <div id="judgeResultsArea" class="mt-2">
                     <h5 id="judgeResultTeamName" class="small mb-1"></h5>
                     <div id="judgeResultAnalysis">
                         <h6 class="small mb-1">Analysis:</h6>
                         <ul id="judgeResultAnalysisList" class="small list-unstyled mb-2"></ul>
                     </div>
                     <div id="judgeResultScore"></div>
                 </div>
                 <p class="mb-0 small text-muted fst-italic mt-2"> <i class="fas fa-info-circle me-1"></i> Simulation only. Not official judging. </p>
            </div>

             <hr class="my-4"> <!-- Stronger separator -->

             <!-- Groups/Leaderboard Area -->
             <div id="groupsLeaderboardSection">
                 <h5 class="text-center mb-3"><i class="fas fa-users-cog me-2" style="color: var(--secondary-color);"></i>Teams / Groups & Simulated Scores</h5>
                 <div id="ai-leaderboard-loading" style="display: none;" class="text-center text-muted small py-3">Loading groups...</div>
                 <div id="ai-leaderboard-empty" style="display: none;" class="text-center text-muted small py-3">No teams/groups registered yet.</div>
                 <div class="table-responsive">
                     <table class="table table-striped table-hover table-sm align-middle small" id="aiLeaderboardTable">
                         <thead class="table-dark small">
                             <tr>
                                 <th scope="col" style="width: 15%; text-align: center;">Rank</th>
                                 <th scope="col">Team / Group Name</th>
                                 <th scope="col" style="width: 35%;">Members</th> <!-- Wider column for members -->
                                 <th scope="col" style="width: 15%; text-align: center;">Score</th>
                             </tr>
                         </thead>
                         <tbody id="ai-leaderboard-body">
                             <!-- Rows populated dynamically -->
                         </tbody>
                     </table>
                 </div>
             </div>

         </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button> </div> </div> </div>
    </div>

    <!-- MODIFIED: Registration Modal -->
    <div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable"> <!-- Larger modal -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registrationModalLabel"><i class="fas fa-user-plus me-2"></i>Hackathon Registration / View Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registrationForm">
                        <!-- User Info Section -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="participantName" class="form-label small">Your Name:</label>
                                <input type="text" class="form-control form-control-sm" id="participantName" readonly disabled>
                            </div>
                            <div class="col-md-6">
                                <label for="universityInput" class="form-label small">School / University / Organization:<span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="universityInput" required placeholder="e.g., Wellington Uni, Example Corp">
                            </div>
                        </div>
                        <!-- Added Fields -->
                        <div class="row mb-3">
                             <div class="col-md-4">
                                <label for="participantAge" class="form-label small">Age:</label>
                                <input type="number" class="form-control form-control-sm" id="participantAge" min="10" max="99" placeholder="e.g., 21">
                             </div>
                             <div class="col-md-8">
                                <label for="participantPhone" class="form-label small">Phone Number:</label>
                                <input type="tel" class="form-control form-control-sm" id="participantPhone" placeholder="+971 5X XXX XXXX (Optional)">
                             </div>
                        </div>
                         <div class="row mb-3">
                             <div class="col-md-4">
                                <label for="participantExperience" class="form-label small">Previous Hackathons?</label>
                                <select class="form-select form-select-sm" id="participantExperience">
                                    <option value="" selected>Select...</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                             </div>
                             <div class="col-md-8">
                                <label for="participantSkills" class="form-label small">Key Skills / Tech Stack:</label>
                                <input type="text" class="form-control form-control-sm" id="participantSkills" placeholder="e.g., Python, React, UI/UX, Data Analysis">
                             </div>
                        </div>
                        <hr>

                        <!-- Team Selection Section -->
                        <div id="teamSelectionArea">
                            <p class="small text-muted mb-2">Choose ONE option below (max 4 members per team/group):</p>
                            <div class="mb-3">
                                <label for="existingTeamSelect" class="form-label small">1. Join Existing Team/Group:</label>
                                <select class="form-select form-select-sm" id="existingTeamSelect">
                                    <option value="">-- Select a team/group to join --</option>
                                    <!-- Teams populated dynamically -->
                                </select>
                                <div id="team-member-count" class="form-text small"></div>
                            </div>

                            <div class="registration-section-divider">OR</div>

                            <div class="mb-3">
                                <label for="newTeamNameInput" class="form-label small">2. Create New Team Name:</label>
                                <input type="text" class="form-control form-control-sm" id="newTeamNameInput" placeholder="Enter unique team name (e.g., AI Wizards)">
                            </div>
                        </div>

                        <!-- Already Registered View -->
                        <div id="alreadyRegisteredView" style="display: none;">
                            <h5 class="text-center mb-3" style="color: var(--secondary-color);">Your Current Team</h5>
                            <p class="text-center">You are registered in team: <strong id="registeredTeamNameDisplay"></strong></p>
                            <p class="text-center small text-muted">Members:</p>
                            <ul id="registeredTeamMembersList" class="list-group list-group-flush text-center small mb-3">
                                <!-- Member list populated dynamically -->
                            </ul>
                            <p class="text-center small fst-italic">To change teams, please Reset your registration via the Profile modal first.</p>
                        </div>

                        <div id="registrationFeedback" class="text-center mt-3"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-sm" id="submitRegistrationBtn">
                        <i class="fas fa-check me-1"></i> Confirm Registration / Join
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal (MODIFIED Footer/Reset) -->
    <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userProfileModalLabel">Your Profile & Progress</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-user-avatar">üë§</div>
                    <h4 id="modal-user-name">Player Name</h4>
                    <div id="modal-welly-points-display">
                        <i class="fas fa-star"></i> <span id="modal-welly-points">0</span> WP
                    </div>
                    <div id="profile-rank-display">Rank: Calculating...</div>
                    <div id="profile-team-display" class="small text-muted mb-3">Team: Not Registered</div> <!-- Added Team Display -->
                    <hr class="my-3">
                    <div id="profile-leaderboard-section">
                        <h5><i class="fas fa-trophy me-2" style="color: var(--primary-color);"></i>Points Leaderboard (Top 5)</h5>
                        <div id="leaderboard-loading" style="display: none;">Loading leaderboard...</div>
                        <div id="leaderboard-empty" style="display: none;">Leaderboard is empty or unavailable.</div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm caption-top" id="profile-leaderboard-table">
                                <thead><tr><th scope="col" style="width: 15%; text-align: center;">Rank</th><th scope="col">Player</th><th scope="col" style="width: 30%; text-align: right;">Points</th></tr></thead>
                                <tbody id="profile-leaderboard-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between align-items-center"> <!-- Align items center -->
                    <div style="flex-grow: 1; text-align: left;"> <!-- Allow feedback to take space -->
                        <button type="button" class="btn btn-danger btn-sm" id="reset-progress-btn"> <!-- Changed ID -->
                            <i class="fas fa-trash-alt me-1"></i> Reset All
                        </button>
                        <div id="reset-feedback" class="small d-block mt-1"></div> <!-- Feedback area below button -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flying Score Element (Keep Existing) -->
    <div id="flying-score-element"></div>

    <!-- Bottom Navigation (Keep Existing, Hackathon active) -->
    <nav class="bottom-nav" aria-label="Mobile navigation">
         <div class="d-flex justify-content-around w-100">
             <a href="index.html" target="_self" class="btn"><i class="fas fa-home"></i>Home</a>
             <a href="courses.html" target="_self" class="btn"><i class="fas fa-book"></i>LMS</a>
             <a href="game.html" target="_self" class="btn"><i class="fas fa-puzzle-piece"></i>Quest</a>
             <a href="hackathons.html" target="_self" class="btn active"><i class="fas fa-laptop-code"></i>Hackathon</a> <!-- Active -->
         </div>
     </nav>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <!-- Mini App & Feature Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tg = window.Telegram.WebApp;
            const MAX_TEAM_MEMBERS = 4;
            const TOTAL_PRESET_GROUPS = 10; // Define the number of preset groups

            // --- Element References ---
            const logo = document.getElementById('header-logo');
            const bodyElement = document.body;
            const userNameDisplay = document.getElementById('user-name-display');
            const wellyPointsDisplay = document.getElementById('welly-points');
            const userAvatarContainer = document.getElementById('user-avatar');
            const userProfileElement = document.getElementById('user-profile');
            const modalChecklist = document.getElementById('modal-checklist');
            const messageArea = document.getElementById('task-message-area');
            const progressBar = document.querySelector('#progress .progress-bar');
            const taskModalElement = document.getElementById('taskTrackerModal');
            const judgeModalElement = document.getElementById('aiJudgeModal');
            const judgeTeamSelect = document.getElementById('judgeTeamSelect');
            const judgeProjectBtn = document.getElementById('judgeProjectBtn');
            const judgeLoader = document.getElementById('judgeLoader');
            const judgeResultsArea = document.getElementById('judgeResultsArea');
            const judgeResultTeamName = document.getElementById('judgeResultTeamName');
            const judgeResultAnalysisList = document.getElementById('judgeResultAnalysisList');
            const judgeResultScore = document.getElementById('judgeResultScore');
            const aiLeaderboardSection = document.getElementById('groupsLeaderboardSection'); // Renamed
            const aiLeaderboardTable = document.getElementById('aiLeaderboardTable');
            const aiLeaderboardBody = document.getElementById('ai-leaderboard-body'); // Renamed
            const aiLeaderboardLoading = document.getElementById('ai-leaderboard-loading');
            const aiLeaderboardEmpty = document.getElementById('ai-leaderboard-empty');
            const flyingScoreElement = document.getElementById('flying-score-element');

            // Profile Modal Elements
            const profileModalElement = document.getElementById('userProfileModal');
            const modalUserAvatar = document.getElementById('modal-user-avatar');
            const modalUserName = document.getElementById('modal-user-name');
            const modalWellyPoints = document.getElementById('modal-welly-points');
            const profileRankDisplay = document.getElementById('profile-rank-display');
            const profileTeamDisplay = document.getElementById('profile-team-display'); // Added
            const profileLeaderboardSection = document.getElementById('profile-leaderboard-section');
            const profileLeaderboardTable = document.getElementById('profile-leaderboard-table');
            const profileLeaderboardTableBody = document.getElementById('profile-leaderboard-body');
            const profileLeaderboardLoading = document.getElementById('leaderboard-loading');
            const profileLeaderboardEmpty = document.getElementById('leaderboard-empty');
            const resetProgressBtn = document.getElementById('reset-progress-btn'); // Changed ID
            const resetFeedbackArea = document.getElementById('reset-feedback');

            // Registration Elements
            const registerTeamBtn = document.getElementById('registerTeamBtn');
            const registrationModalElement = document.getElementById('registrationModal');
            const registrationForm = document.getElementById('registrationForm');
            const participantNameInput = document.getElementById('participantName');
            const universityInput = document.getElementById('universityInput');
            const participantAgeInput = document.getElementById('participantAge'); // Added
            const participantPhoneInput = document.getElementById('participantPhone'); // Added
            const participantExperienceSelect = document.getElementById('participantExperience'); // Added
            const participantSkillsInput = document.getElementById('participantSkills'); // Added
            const teamSelectionArea = document.getElementById('teamSelectionArea');
            const existingTeamSelect = document.getElementById('existingTeamSelect');
            const newTeamNameInput = document.getElementById('newTeamNameInput');
            const submitRegistrationBtn = document.getElementById('submitRegistrationBtn');
            const registrationFeedback = document.getElementById('registrationFeedback');
            const registrationStatusMsg = document.getElementById('registration-status-message');
            const teamMemberCountDisplay = document.getElementById('team-member-count');
            const alreadyRegisteredView = document.getElementById('alreadyRegisteredView'); // Added
            const registeredTeamNameDisplay = document.getElementById('registeredTeamNameDisplay'); // Added
            const registeredTeamMembersList = document.getElementById('registeredTeamMembersList'); // Added


            // --- CloudStorage Keys ---
            const POINTS_KEY = 'wellyPoints_v2'; // Use distinct keys
            const TASK_STATE_KEY = 'hackathonTasks_v2'; // Use distinct keys
            const POINTS_LEADERBOARD_KEY = 'pointsLeaderboard_v2';
            const HACKATHON_TEAMS_KEY = 'hackathonTeamsData_v3'; // Stores ALL team data { teamName: { members: [...], theme: "...", score: 0 }, ... }
            const USER_REGISTRATION_KEY_PREFIX = 'userHackReg_v2_'; // Stores user's team name: userHackReg_v2_USERID = "TeamName"


            // --- State Variables ---
            let currentUser = null;
            let totalWellyPoints = 0;
            let taskState = {};
            let hackathonTeamsData = {}; // Structure: { teamName: { members: [{id, name, university, age?, phone?, experience?, skills?}], theme: null, score: 0 (simulated) } }
            let userRegisteredTeam = null; // Store the team name the current user is registered to

            // --- PRESET GROUP NAMES (Generate 10) ---
            const PRESET_GROUP_NAMES = Array.from({ length: TOTAL_PRESET_GROUPS }, (_, i) => `Group ${String.fromCharCode(65 + i)}`); // Group A, Group B, ... Group J


            // --- Initialize Telegram Mini App & Profile ---
            async function initializeTelegramApp() {
                try {
                    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        tg.ready();
                        tg.expand();
                         // Only show back button if needed
                         tg.BackButton.isVisible ? tg.BackButton.show() : tg.BackButton.hide();
                         tg.onEvent('backButtonClicked', handleBackButton);


                        currentUser = tg.initDataUnsafe.user;
                        console.log("User Initialized:", currentUser);
                        updateUserProfileDisplay();

                        if (registerTeamBtn) registerTeamBtn.disabled = false;

                        await Promise.all([
                            loadWellyPoints(),
                            loadTaskState(),
                            loadHackathonTeams(), // Load team structure first
                            checkUserRegistration() // Then check if user is part of a team
                        ]);

                        initializeTaskUI();
                        updateProgressBar();
                        updateAiJudgeModal(); // Update judge dropdown AND leaderboard
                        updateRegistrationButtonState();

                        console.log("Telegram Mini App Initialized.");
                         if (!tg.CloudStorage) {
                            console.warn("CloudStorage is NOT available.");
                            tg.showAlert("Warning: Cloud Storage not available. Progress & Teams might not be saved/synced.", () => {});
                        }
                    } else {
                        console.warn("Not running in Telegram context or user data unavailable.");
                        displayGuestProfile();
                        taskState = loadTaskStateLocal(); // Load from LS for guests
                        initializeTaskUI();
                        updateProgressBar();
                        // Show only preset groups/teams for guests in AI judge if desired
                        hackathonTeamsData = PRESET_GROUP_NAMES.reduce((acc, name) => {
                            acc[name] = { members: [], theme: "Preset Theme", score: 0 };
                            return acc;
                        }, {});
                        updateAiJudgeModal();
                    }
                } catch (error) {
                     console.error("Error during Telegram App Initialization:", error);
                     displayGuestProfile();
                     tg?.showAlert(`Initialization Error: ${error.message || error}`);
                }
            }

            function displayGuestProfile() {
                 if(userProfileElement) {
                     userProfileElement.style.display = 'flex';
                     userProfileElement.removeAttribute('data-bs-toggle');
                     userProfileElement.removeAttribute('data-bs-target');
                     userProfileElement.style.cursor = 'default';
                 }
                 if(registerTeamBtn) {
                     registerTeamBtn.disabled = true;
                     registerTeamBtn.innerHTML = '<i class="fas fa-lock me-2"></i> Login via Telegram';
                     if (registrationStatusMsg) registrationStatusMsg.textContent = "Login to register or view teams.";
                 }
                 if(userNameDisplay) userNameDisplay.textContent = 'Guest';
                 if(userAvatarContainer) userAvatarContainer.innerHTML = 'üë§';
                 if(wellyPointsDisplay) wellyPointsDisplay.textContent = '0';
                 if (resetProgressBtn) resetProgressBtn.disabled = true;
            }

            function handleBackButton() {
                window.history.length > 1 ? window.history.back() : tg?.close();
            }

            function updateUserProfileDisplay() {
                 const isGuest = !currentUser;
                 const displayName = isGuest ? 'Guest' : (currentUser.first_name || 'Player');
                 const photoUrl = isGuest ? null : currentUser.photo_url;
                 const currentPoints = isGuest ? 0 : totalWellyPoints;

                 // Header Update
                 if (userNameDisplay) userNameDisplay.textContent = displayName;
                 if (userAvatarContainer) {
                     userAvatarContainer.innerHTML = photoUrl ? `<img src="${photoUrl}" alt="Avatar">` : (isGuest ? 'üë§' : 'üéì');
                 }
                 if (wellyPointsDisplay) wellyPointsDisplay.textContent = currentPoints;

                 // Profile Modal Update
                 if (modalUserName) modalUserName.textContent = displayName;
                 if (modalUserAvatar) {
                    modalUserAvatar.innerHTML = photoUrl ? `<img src="${photoUrl}" alt="Profile picture">` : 'üéì';
                 }
                 if (modalWellyPoints) modalWellyPoints.textContent = currentPoints;
                 // Update team display in profile modal
                 if(profileTeamDisplay) {
                     profileTeamDisplay.textContent = userRegisteredTeam ? `Team: ${userRegisteredTeam}` : 'Team: Not Registered';
                     profileTeamDisplay.className = `small mb-3 ${userRegisteredTeam ? 'text-success fw-bold' : 'text-muted'}`;
                 }
            }

             // --- Welly Points Management ---
             function loadWellyPoints() {
                 return new Promise((resolve) => {
                     totalWellyPoints = 0; // Default
                     if (currentUser && tg?.CloudStorage) {
                          tg.CloudStorage.getItem(POINTS_KEY, (error, value) => {
                               if (error) { console.error(`CS Load Error (${POINTS_KEY}):`, error); }
                               else if (value) { totalWellyPoints = parseInt(value, 10) || 0; }
                               updateUserProfileDisplay();
                               resolve();
                          });
                     } else { updateUserProfileDisplay(); resolve(); }
                 });
             }
            function saveWellyPoints() { /* (Keep existing save logic using POINTS_KEY) */
                 return new Promise((resolve, reject) => {
                     if (currentUser && tg?.CloudStorage) {
                         tg.CloudStorage.setItem(POINTS_KEY, totalWellyPoints.toString(), (error, success) => {
                              if (error) { console.error(`CS Save Error (${POINTS_KEY}):`, error); reject(error); }
                              else { console.log(`WP saved (${POINTS_KEY}) for ${currentUser.id}: ${totalWellyPoints}`); resolve(success); }
                         });
                     } else { console.warn("CS/User not available for WP save."); resolve(false); }
                 });
            }
            function showPointsGainAnimation(points) { /* (Keep existing) */
                 if (!userProfileElement || points <= 0) return;
                 const gainElement = document.createElement('div');
                 gainElement.textContent = `+${points} WP`;
                 gainElement.className = 'welly-points-gain';
                 document.body.appendChild(gainElement);
                 const profileRect = userProfileElement.getBoundingClientRect();
                 const startX = profileRect.left + profileRect.width / 2;
                 const startY = profileRect.bottom + 10;
                 gainElement.style.left = `${startX}px`;
                 gainElement.style.top = `${startY}px`;
                 gainElement.style.opacity = '0'; gainElement.style.transform = 'translateX(-50%) scale(0.8)';
                 requestAnimationFrame(() => { gainElement.style.top = `${startY - 40}px`; gainElement.style.opacity = '1'; gainElement.style.transform = 'translateX(-50%) scale(1)'; });
                 setTimeout(() => { gainElement.style.opacity = '0'; gainElement.style.transform = 'translateX(-50%) scale(0.8)'; setTimeout(() => gainElement.remove(), 800); }, 1000);
            }

            // --- Shrinking Logo Logic (Keep existing) ---
            function setupLogoScroll() { /* (Keep existing) */ if (logo) { const handleScroll = () => { const isScrolled = window.scrollY > 30; logo.classList.toggle('logo-scrolled', isScrolled); bodyElement.classList.toggle('logo-state-scrolled', isScrolled); }; logo.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }); window.addEventListener('scroll', handleScroll, { passive: true }); handleScroll(); } }

            // --- Task Tracker Logic ---
            function loadTaskState() { /* (Keep existing logic using TASK_STATE_KEY) */
                return new Promise((resolve) => {
                    taskState = {};
                    if (currentUser && tg?.CloudStorage) {
                        tg.CloudStorage.getItem(TASK_STATE_KEY, (error, value) => {
                            if (error) { console.error("CS Task Load Error:", error); taskState = loadTaskStateLocal(); }
                            else if (value) { try { taskState = JSON.parse(value); } catch (e) { taskState = loadTaskStateLocal(); } }
                            else { taskState = loadTaskStateLocal(); }
                            resolve();
                        });
                    } else { taskState = loadTaskStateLocal(); resolve(); }
                });
            }
            function loadTaskStateLocal() { const storedState = localStorage.getItem(TASK_STATE_KEY); try { return storedState ? JSON.parse(storedState) : {}; } catch (e) { return {}; } }
            function saveTaskState(state) { /* (Keep existing logic using TASK_STATE_KEY) */
                 const stateString = JSON.stringify(state);
                 if (currentUser && tg?.CloudStorage) {
                     tg.CloudStorage.setItem(TASK_STATE_KEY, stateString, (error) => { if (error) console.error("CS Task Save Error:", error); else console.log("Task State saved to CS."); });
                 }
                 try { localStorage.setItem(TASK_STATE_KEY, stateString); } catch (e) { console.error("LS Task Save Error:", e); }
            }
            function initializeTaskUI() { if (!modalChecklist) return; modalChecklist.querySelectorAll('.checklist-item[data-task-id]').forEach(item => { const taskId = item.dataset.taskId; updateTaskUI(taskId, taskState[taskId] === true); }); }
            function updateTaskUI(taskId, isCompleted) { const modalItem = modalChecklist?.querySelector(`.checklist-item[data-task-id="${taskId}"]`); if (modalItem) { modalItem.classList.toggle('completed', isCompleted); modalItem.style.cursor = isCompleted ? 'default' : 'pointer'; } } // Prevent clicking completed
            function showMessage(message, type = 'success', area = messageArea, clearPrevious = true) { /* (Keep existing) */ if (area) { if (clearPrevious) area.innerHTML = ''; const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type} alert-dismissible fade show small p-2`; alertDiv.setAttribute('role', 'alert'); alertDiv.innerHTML = `${message}<button type="button" class="btn-close btn-sm p-2" data-bs-dismiss="alert" aria-label="Close"></button>`; area.appendChild(alertDiv); } }
            function clearMessages(area = messageArea) { if (area) area.innerHTML = ''; }
            function updateProgressBar() { /* (Keep existing) */ const taskItems = modalChecklist?.querySelectorAll('.checklist-item[data-task-id]'); if (!taskItems || taskItems.length === 0 || !progressBar) return; const totalTasks = taskItems.length; const completedTasks = Object.values(taskState).filter(status => status === true).length; const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0; progressBar.style.width = progressPercent + '%'; progressBar.textContent = `${progressPercent}%`; progressBar.setAttribute('aria-valuenow', progressPercent); progressBar.classList.toggle('bg-success', progressPercent === 100); progressBar.classList.toggle('progress-bar-animated', progressPercent < 100); progressBar.classList.toggle('progress-bar-striped', progressPercent < 100); }

            // Modified Task Click Handler
            if (modalChecklist) {
                modalChecklist.addEventListener('click', async function(event) {
                    const taskItem = event.target.closest('.checklist-item[data-task-id]');
                    if (!taskItem || !currentUser || taskItem.classList.contains('completed')) return; // Ignore clicks on completed or if not logged in

                    const taskId = taskItem.dataset.taskId;
                    const taskNameElement = taskItem.querySelector('strong');
                    const taskName = taskNameElement ? taskNameElement.textContent.trim() : `Task ${taskId}`;
                    const pointsToAdd = parseInt(taskItem.dataset.points || '0', 10);
                    clearMessages();

                    // Special check for 'join_group' task - require registration first
                    if (taskId === 'join_group' && !userRegisteredTeam) {
                        showMessage(`You must register or join a team first (use the main button).`, 'warning');
                        return;
                    }

                    // Use Telegram confirmation
                    if (tg && tg.showConfirm) {
                        tg.showConfirm(`Mark "${taskName}" as complete and claim ${pointsToAdd} WP?`, async (confirmed) => {
                            if (confirmed) {
                                taskState[taskId] = true;
                                saveTaskState(taskState);
                                updateTaskUI(taskId, true);
                                updateProgressBar();

                                if (pointsToAdd > 0) {
                                    totalWellyPoints += pointsToAdd;
                                    try {
                                        await saveWellyPoints();
                                        updateUserProfileDisplay();
                                        showPointsGainAnimation(pointsToAdd);
                                        showMessage(`Task "${taskName}" complete! +${pointsToAdd} WP earned. <span class="celebration-emoji">${taskItem.querySelector('.celebration-emoji')?.textContent || '‚úÖ'}</span>`, 'success');
                                        updatePointsLeaderboardWithCurrentUser(totalWellyPoints); // Update global leaderboard in background
                                    } catch (error) {
                                        console.error("Failed to save points/leaderboard after task:", error);
                                        showMessage(`Task marked complete, but failed to save points. Error: ${error.message}`, 'danger');
                                        totalWellyPoints -= pointsToAdd; // Revert points locally
                                    }
                                } else {
                                    showMessage(`Task "${taskName}" complete! <span class="celebration-emoji">${taskItem.querySelector('.celebration-emoji')?.textContent || '‚úÖ'}</span>`, 'success');
                                }
                            }
                        });
                    } else {
                        // Fallback for non-Telegram environment
                        if (confirm(`Mark "${taskName}" as complete and claim ${pointsToAdd} WP?`)) {
                            taskState[taskId] = true; saveTaskState(taskState); updateTaskUI(taskId, true); updateProgressBar();
                            if (pointsToAdd > 0) { totalWellyPoints += pointsToAdd; await saveWellyPoints(); updateUserProfileDisplay(); showPointsGainAnimation(pointsToAdd); showMessage(`Task "${taskName}" complete! +${pointsToAdd} WP.`, 'success'); updatePointsLeaderboardWithCurrentUser(totalWellyPoints); }
                            else { showMessage(`Task "${taskName}" complete!`, 'success'); }
                        }
                    }
                });
            } else console.warn("Modal checklist container (#modal-checklist) not found.");

            if (taskModalElement) taskModalElement.addEventListener('hidden.bs.modal', () => clearMessages());

            // --- Hackathon Team & Registration Logic ---
            function getUserRegistrationKey() { return currentUser ? `${USER_REGISTRATION_KEY_PREFIX}${currentUser.id}` : null; }

            function loadHackathonTeams() {
                return new Promise((resolve) => {
                    hackathonTeamsData = {}; // Reset
                    if (tg?.CloudStorage) {
                        tg.CloudStorage.getItem(HACKATHON_TEAMS_KEY, (error, value) => {
                            if (error) { console.error(`CS Load Error (${HACKATHON_TEAMS_KEY}):`, error); }
                            else if (value) { try { hackathonTeamsData = JSON.parse(value); console.log("Loaded Teams from CS:", Object.keys(hackathonTeamsData).length); } catch (e) { console.error("Error parsing Teams from CS:", e); hackathonTeamsData = {}; } }
                            else { console.log("No Teams found in CS."); }

                             // Ensure preset groups exist if not created by users yet
                             PRESET_GROUP_NAMES.forEach(name => {
                                if (!hackathonTeamsData[name]) {
                                    hackathonTeamsData[name] = { members: [], theme: "Preset Theme", score: 0 };
                                }
                             });
                             console.log("Total teams/groups after load/preset:", Object.keys(hackathonTeamsData).length);
                            resolve();
                        });
                    } else {
                        // Non-TG fallback: just presets
                         hackathonTeamsData = PRESET_GROUP_NAMES.reduce((acc, name) => {
                            acc[name] = { members: [], theme: "Preset Theme", score: 0 };
                            return acc;
                         }, {});
                         resolve();
                    }
                });
            }

            function saveHackathonTeams() {
                return new Promise((resolve, reject) => {
                    if (tg?.CloudStorage) {
                        tg.CloudStorage.setItem(HACKATHON_TEAMS_KEY, JSON.stringify(hackathonTeamsData), (error, success) => {
                            if (error) { console.error(`CS Save Error (${HACKATHON_TEAMS_KEY}):`, error); reject(error); }
                            else { console.log("Teams saved to CS:", Object.keys(hackathonTeamsData).length); resolve(success); }
                        });
                    } else { console.warn("CS not available. Teams not saved."); resolve(false); }
                });
            }

            function checkUserRegistration() {
                return new Promise((resolve) => {
                    userRegisteredTeam = null;
                    const userRegKey = getUserRegistrationKey();
                    if (userRegKey && tg?.CloudStorage) {
                        tg.CloudStorage.getItem(userRegKey, (error, value) => {
                            if (error) { console.error(`CS Load Error (${userRegKey}):`, error); }
                            else if (value && value.trim() !== '') {
                                const potentialTeamName = value.trim();
                                // Verify the team still exists in the main data
                                if (hackathonTeamsData[potentialTeamName]) {
                                     userRegisteredTeam = potentialTeamName;
                                     console.log(`User ${currentUser.id} registered to team: ${userRegisteredTeam}`);
                                } else {
                                     console.warn(`User ${currentUser.id} was registered to non-existent team "${potentialTeamName}". Removing registration.`);
                                     removeUserRegistration(); // Clean up invalid registration
                                }
                             }
                            resolve();
                        });
                    } else { resolve(); }
                });
            }

            function saveUserRegistration(teamName) {
                 return new Promise((resolve, reject) => {
                     const userRegKey = getUserRegistrationKey();
                     if (userRegKey && tg?.CloudStorage) {
                         tg.CloudStorage.setItem(userRegKey, teamName, (error, success) => {
                             if (error) { console.error(`CS Save Error (${userRegKey}):`, error); reject(error); }
                             else { userRegisteredTeam = teamName; console.log(`User ${currentUser.id} registration saved for: ${teamName}`); resolve(success); }
                         });
                     } else { console.warn("CS/UserKey not available. User registration not saved."); resolve(false); }
                 });
            }

            function removeUserRegistration() {
                 return new Promise((resolve, reject) => {
                     const userRegKey = getUserRegistrationKey();
                     if (userRegKey && tg?.CloudStorage) {
                         tg.CloudStorage.removeItem(userRegKey, (error, success) => {
                             if (error) { console.error(`CS Remove Error (${userRegKey}):`, error); reject(error); }
                             else { userRegisteredTeam = null; console.log(`User ${currentUser.id} registration removed.`); resolve(success); }
                         });
                     } else { console.warn("CS/UserKey not available. User registration not removed."); resolve(false); }
                 });
            }

             function populateRegistrationForm() {
                 if (!currentUser || !registrationModalElement) return;

                 // Pre-fill user info
                 if (participantNameInput) participantNameInput.value = currentUser.first_name || '';
                 // Clear dynamic fields
                 if (universityInput) universityInput.value = '';
                 if (participantAgeInput) participantAgeInput.value = '';
                 if (participantPhoneInput) participantPhoneInput.value = '';
                 if (participantExperienceSelect) participantExperienceSelect.selectedIndex = 0;
                 if (participantSkillsInput) participantSkillsInput.value = '';
                 if (existingTeamSelect) { existingTeamSelect.innerHTML = '<option value="">-- Select a team/group to join --</option>'; }
                 if (newTeamNameInput) newTeamNameInput.value = '';
                 if (registrationFeedback) registrationFeedback.innerHTML = '';
                 if (teamMemberCountDisplay) teamMemberCountDisplay.textContent = '';

                  // Populate existing teams dropdown (including presets)
                 Object.entries(hackathonTeamsData)
                    .sort(([nameA], [nameB]) => nameA.localeCompare(nameB)) // Sort alphabetically
                    .forEach(([teamName, teamData]) => {
                        if (teamData && teamData.members) {
                            const memberCount = teamData.members.length;
                            // Add to dropdown ONLY if team is not full
                            if (memberCount < MAX_TEAM_MEMBERS) {
                                const option = document.createElement('option');
                                option.value = teamName;
                                option.textContent = `${teamName} (${memberCount}/${MAX_TEAM_MEMBERS} members)`;
                                option.dataset.count = memberCount;
                                if (existingTeamSelect) existingTeamSelect.appendChild(option);
                            }
                        }
                    });

                 // Listener for member count
                 if(existingTeamSelect && teamMemberCountDisplay){
                     existingTeamSelect.removeEventListener('change', updateMemberCountDisplay); // Remove previous listener if exists
                     existingTeamSelect.addEventListener('change', updateMemberCountDisplay);
                 }

                 // Check registration status and update UI accordingly
                 if (userRegisteredTeam && hackathonTeamsData[userRegisteredTeam]) {
                    // User IS registered
                    teamSelectionArea.style.display = 'none';
                    alreadyRegisteredView.style.display = 'block';
                    submitRegistrationBtn.style.display = 'none'; // Hide submit button
                    registeredTeamNameDisplay.textContent = userRegisteredTeam;

                    // Populate member list and potentially user's details
                    registeredTeamMembersList.innerHTML = '';
                    const team = hackathonTeamsData[userRegisteredTeam];
                    let userDetailsFound = false;
                    team.members.forEach(member => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = member.name || `User ID: ${member.id}`;
                        if (member.id === currentUser.id) {
                            li.innerHTML += ' <small class="text-muted fst-italic">(You)</small>';
                            // Pre-fill fields from stored data if available
                            if (member.university && universityInput) universityInput.value = member.university;
                            if (member.age && participantAgeInput) participantAgeInput.value = member.age;
                            if (member.phone && participantPhoneInput) participantPhoneInput.value = member.phone;
                            if (member.experience && participantExperienceSelect) participantExperienceSelect.value = member.experience;
                            if (member.skills && participantSkillsInput) participantSkillsInput.value = member.skills;
                            userDetailsFound = true;
                        }
                        registeredTeamMembersList.appendChild(li);
                    });

                    // Disable form fields in 'view' mode
                    universityInput.disabled = true;
                    participantAgeInput.disabled = true;
                    participantPhoneInput.disabled = true;
                    participantExperienceSelect.disabled = true;
                    participantSkillsInput.disabled = true;

                    if (!userDetailsFound) {
                        console.warn("User is registered to team, but their member data wasn't found in the team list.");
                    }


                 } else {
                    // User is NOT registered
                    teamSelectionArea.style.display = 'block';
                    alreadyRegisteredView.style.display = 'none';
                    submitRegistrationBtn.style.display = 'inline-block'; // Show submit button
                    submitRegistrationBtn.disabled = false; // Ensure enabled
                    // Enable form fields
                    universityInput.disabled = false;
                    participantAgeInput.disabled = false;
                    participantPhoneInput.disabled = false;
                    participantExperienceSelect.disabled = false;
                    participantSkillsInput.disabled = false;
                    existingTeamSelect.disabled = false;
                    newTeamNameInput.disabled = false;
                 }
             }

             function updateMemberCountDisplay() { // Extracted function for listener
                  if(!existingTeamSelect || !teamMemberCountDisplay) return;
                  const selectedOption = existingTeamSelect.options[existingTeamSelect.selectedIndex];
                  if(selectedOption && selectedOption.value){
                      const count = selectedOption.dataset.count || 0;
                      const newCount = parseInt(count) + 1;
                      teamMemberCountDisplay.textContent = `This team/group has ${count} member(s). Joining makes ${newCount}.`;
                      teamMemberCountDisplay.className = `form-text small ${newCount > MAX_TEAM_MEMBERS ? 'text-danger fw-bold' : ''}`;
                  } else {
                       teamMemberCountDisplay.textContent = '';
                  }
             }

            function updateRegistrationButtonState() {
                if (registerTeamBtn) {
                    if (userRegisteredTeam) {
                        registerTeamBtn.innerHTML = `<i class="fas fa-users-cog me-2 text-success"></i> View Team: ${userRegisteredTeam}`;
                        if (registrationStatusMsg) registrationStatusMsg.textContent = "Click to view details or change team via Profile Reset.";
                    } else if (currentUser) {
                        registerTeamBtn.innerHTML = `<i class="fas fa-user-plus me-2"></i> Register / Join Team`;
                        if (registrationStatusMsg) registrationStatusMsg.textContent = "Register yourself or join a team/group.";
                    } else {
                         registerTeamBtn.innerHTML = '<i class="fas fa-lock me-2"></i> Login via Telegram';
                         if (registrationStatusMsg) registrationStatusMsg.textContent = "Login to register or view teams.";
                         registerTeamBtn.disabled = true;
                    }
                }
            }

            async function handleRegistrationSubmit() {
                if (!currentUser) { showMessage("User data not loaded.", 'danger', registrationFeedback); return; }
                if (userRegisteredTeam) { showMessage("You are already registered.", 'warning', registrationFeedback); return; } // Should be prevented by UI state, but double-check

                clearMessages(registrationFeedback);
                const university = universityInput.value.trim();
                const age = participantAgeInput.value.trim();
                const phone = participantPhoneInput.value.trim();
                const experience = participantExperienceSelect.value;
                const skills = participantSkillsInput.value.trim();
                const selectedTeam = existingTeamSelect.value;
                const newTeamName = newTeamNameInput.value.trim();

                // --- Validation ---
                if (!university) { showMessage("Please enter your School/University/Organization.", 'danger', registrationFeedback); universityInput.focus(); return; }
                 // Optional fields don't need strict validation unless specific format required
                 // Age validation (basic)
                 if (age && (isNaN(parseInt(age)) || parseInt(age) < 10 || parseInt(age) > 99)) {
                    showMessage("Please enter a valid age (10-99).", 'danger', registrationFeedback); participantAgeInput.focus(); return;
                 }
                if (!selectedTeam && !newTeamName) { showMessage("Please either select an existing team/group or enter a new team name.", 'danger', registrationFeedback); return; }
                if (selectedTeam && newTeamName) { showMessage("Please choose only ONE option: Join OR Create team.", 'danger', registrationFeedback); return; }

                let targetTeamName = '';
                let isNewTeam = false;

                // Disable button/fields during processing
                submitRegistrationBtn.disabled = true;
                const formElements = registrationForm.elements;
                for (let i = 0; i < formElements.length; i++) { formElements[i].disabled = true; }
                showMessage("Processing registration...", 'info', registrationFeedback);

                try {
                    // Reload latest team data (mitigates some race conditions)
                    await loadHackathonTeams();

                    if (selectedTeam) {
                        // --- Join Existing Team/Group ---
                        targetTeamName = selectedTeam;
                        if (!hackathonTeamsData[targetTeamName] || !hackathonTeamsData[targetTeamName].members) {
                            throw new Error(`Selected team/group "${targetTeamName}" seems invalid. Please refresh and try again.`);
                        }
                        if (hackathonTeamsData[targetTeamName].members.length >= MAX_TEAM_MEMBERS) {
                            throw new Error(`Team/Group "${targetTeamName}" is already full (${MAX_TEAM_MEMBERS} members).`);
                        }
                         if (hackathonTeamsData[targetTeamName].members.some(m => m.id === currentUser.id)) {
                             throw new Error(`You seem to already be in team/group "${targetTeamName}".`); // Should not happen if UI is correct
                         }
                    } else {
                        // --- Create New Team ---
                        targetTeamName = newTeamName;
                        if (targetTeamName.length < 3) { throw new Error("New team name must be at least 3 characters."); }
                        // Case-insensitive check
                        const existingTeamKey = Object.keys(hackathonTeamsData).find(key => key.toLowerCase() === targetTeamName.toLowerCase());
                        if (existingTeamKey) {
                            throw new Error(`Team name "${targetTeamName}" is already taken. Please choose another.`);
                        }
                        isNewTeam = true;
                    }

                    // --- Prepare User Data ---
                    const newUserMember = {
                        id: currentUser.id,
                        name: currentUser.first_name || `User ${currentUser.id}`,
                        university: university,
                        age: age || null, // Store as null if empty
                        phone: phone || null,
                        experience: experience || null,
                        skills: skills || null,
                    };

                    // --- Update Team Data Structure ---
                    if (isNewTeam) {
                        hackathonTeamsData[targetTeamName] = { members: [newUserMember], theme: null, score: 0 }; // Initialize new team
                    } else {
                         hackathonTeamsData[targetTeamName].members.push(newUserMember);
                    }

                    // --- Save Updates ---
                    const teamsSaved = await saveHackathonTeams();
                    if (!teamsSaved && tg?.CloudStorage) throw new Error("Failed to save team data to cloud. Please try again."); // Check if CS failed

                    const registrationSaved = await saveUserRegistration(targetTeamName);
                     if (!registrationSaved && tg?.CloudStorage) {
                         // Attempt rollback if user registration link failed
                         console.error("Failed to save user registration link after team update! Rolling back team change.");
                         if (isNewTeam) { delete hackathonTeamsData[targetTeamName]; }
                         else { hackathonTeamsData[targetTeamName].members = hackathonTeamsData[targetTeamName].members.filter(m => m.id !== currentUser.id); }
                         await saveHackathonTeams(); // Try to save the rollback
                         throw new Error("Failed to save your registration link. Team change reverted.");
                     }

                    // --- Success ---
                    showMessage(`Successfully registered for team: <strong>${targetTeamName}</strong>!`, 'success', registrationFeedback);
                    updateAiJudgeModal(); // Update judge list/leaderboard
                    updateRegistrationButtonState(); // Update main button text
                    updateUserProfileDisplay(); // Update team in profile header display

                    // Trigger the 'join_group' task automatically if not already done
                    if (!taskState['join_group']) {
                        console.log("Automatically completing 'join_group' task upon registration.");
                        taskState['join_group'] = true;
                        saveTaskState(taskState);
                        updateTaskUI('join_group', true);
                        updateProgressBar();
                        const joinPoints = parseInt(modalChecklist?.querySelector('.checklist-item[data-task-id="join_group"]')?.dataset.points || '0', 10);
                        if (joinPoints > 0) {
                             totalWellyPoints += joinPoints;
                             await saveWellyPoints();
                             updateUserProfileDisplay();
                             showPointsGainAnimation(joinPoints);
                             updatePointsLeaderboardWithCurrentUser(totalWellyPoints);
                        }
                    }

                    // Close modal after delay
                    setTimeout(() => {
                        const modalInstance = bootstrap.Modal.getInstance(registrationModalElement);
                        if (modalInstance) modalInstance.hide();
                         // Re-enable form fields after modal closes fully
                         registrationModalElement.addEventListener('hidden.bs.modal', () => {
                              for (let i = 0; i < formElements.length; i++) { formElements[i].disabled = false; }
                         }, { once: true });

                    }, 2000); // Slightly longer delay

                } catch (error) {
                     console.error("Registration Error:", error);
                     showMessage(`${error.message || 'An unknown error occurred.'}`, 'danger', registrationFeedback);
                     // Re-enable form fields on error only if user is still not registered
                     if (!userRegisteredTeam) {
                          for (let i = 0; i < formElements.length; i++) { formElements[i].disabled = false; }
                          submitRegistrationBtn.disabled = false;
                          // Don't repopulate here, let the user retry or close
                     }
                }
            }


            // Add listeners for registration modal
            if (registrationModalElement) {
                 registrationModalElement.addEventListener('show.bs.modal', async () => {
                     // Ensure latest team data is loaded *before* populating form
                     await loadHackathonTeams();
                     await checkUserRegistration(); // Re-check user's status
                     populateRegistrationForm(); // Populate based on latest data
                 });
            }
            if (submitRegistrationBtn) {
                 submitRegistrationBtn.addEventListener('click', handleRegistrationSubmit);
            }

            // --- AI Judge & Group/Leaderboard Logic ---

            // Updates both the judge dropdown and the main leaderboard table in the AI Judge modal
            function updateAiJudgeModal() {
                 if (!judgeTeamSelect || !aiLeaderboardBody || !aiLeaderboardLoading || !aiLeaderboardEmpty || !aiLeaderboardTable) return;

                 aiLeaderboardLoading.style.display = 'block';
                 aiLeaderboardTable.style.display = 'none';
                 aiLeaderboardEmpty.style.display = 'none';
                 aiLeaderboardBody.innerHTML = '';
                 const judgeDropdownCurrentValue = judgeTeamSelect.value;
                 judgeTeamSelect.innerHTML = '<option selected disabled value="">-- Choose Registered Team/Group --</option>';

                 const teamsArray = Object.entries(hackathonTeamsData)
                     .map(([name, data]) => ({ name, ...data })) // Convert to array of objects
                     .filter(team => team.members && team.members.length > 0) // Only show teams with members
                     .sort((a, b) => b.score - a.score); // Sort by score DESC for leaderboard ranking

                 if (teamsArray.length === 0) {
                     aiLeaderboardLoading.style.display = 'none';
                     aiLeaderboardEmpty.style.display = 'block';
                 } else {
                     aiLeaderboardLoading.style.display = 'none';
                     aiLeaderboardTable.style.display = 'table';

                     teamsArray.forEach((team, index) => {
                         const rank = index + 1;
                         const teamName = team.name;
                         const score = team.score || 0; // Default score if missing
                         const members = team.members || [];

                         // Add to Leaderboard Table
                         const row = aiLeaderboardBody.insertRow();
                         row.setAttribute('data-team', teamName);
                         const membersHtml = members.map(m => m.name || `User ${m.id}`).join(', ') || '<em class="text-muted">No members yet</em>';
                         row.innerHTML = `
                             <td class="text-center"><span class="rank-badge">${rank}</span></td>
                             <td class="fw-bold">${teamName}</td>
                             <td class="small">${membersHtml}</td>
                             <td class="text-center score-display">${score.toFixed(1)}</td>
                         `;

                         // Add to Judge Dropdown
                         const option = document.createElement('option');
                         option.value = teamName;
                         option.textContent = `${teamName} (${members.length} Member${members.length !== 1 ? 's' : ''})`;
                         judgeTeamSelect.appendChild(option);
                     });

                     // Try to restore dropdown selection
                     if (judgeDropdownCurrentValue && judgeTeamSelect.querySelector(`option[value="${judgeDropdownCurrentValue}"]`)) {
                         judgeTeamSelect.value = judgeDropdownCurrentValue;
                     }
                 }
            }

            // AI Judge Simulation Data (Example Analysis)
            const teamAnalysisData = { /* (Keep existing or expand) */ };
            function displayAnalysisSequentially(analysisPoints) { /* (Keep existing) */
                 if (!judgeResultAnalysisList) return 0; judgeResultAnalysisList.innerHTML = ''; let delay = 0; const interval = 250;
                 analysisPoints.forEach((point) => { setTimeout(() => { const li = document.createElement('li'); li.textContent = point; judgeResultAnalysisList.appendChild(li); requestAnimationFrame(() => li.classList.add('visible')); const modalBody = judgeModalElement.querySelector('.modal-body'); if (modalBody) modalBody.scrollTop = modalBody.scrollHeight; }, delay); delay += interval; }); return delay;
            }
            function generateScore(teamName) { /* (Keep existing or refine) */ let base = 6.0 + Math.random() * 1.5; let bonus = PRESET_GROUP_NAMES.includes(teamName) ? Math.random() * 0.5 : Math.random(); let score = Math.min(Math.max(base + bonus, 4.0), 9.8); return parseFloat(score.toFixed(1)); }

            async function runJudgeSimulation(teamName) {
                 if (!teamName || !hackathonTeamsData[teamName]) {
                     throw new Error("Invalid team selected for judging.");
                 }
                 const score = generateScore(teamName);
                 const analysisPoints = teamAnalysisData[teamName] || [`Analyzing team "${teamName}"...`, "Checking member synergy...", "Evaluating potential score...", "Score generated."];

                 // Update score in main data structure
                 hackathonTeamsData[teamName].score = score;

                 // Save the updated team data (with the new score)
                 // We do this asynchronously in the background, no need to await here for UI speed
                 saveHackathonTeams().catch(err => console.error("Failed to save team data after judging:", err));

                 return { score, analysisPoints };
             }

            function animateScoreToLeaderboard(teamName, score) { /* (Keep existing - targets aiLeaderboardBody now) */
                if (!flyingScoreElement || !judgeResultScore || !aiLeaderboardBody || !judgeModalElement) return;
                const targetRow = aiLeaderboardBody.querySelector(`tr[data-team="${teamName}"]`);
                let targetY, targetX;
                const modalRect = judgeModalElement.getBoundingClientRect();
                if (targetRow) { const rowRect = targetRow.getBoundingClientRect(); targetY = rowRect.top + (rowRect.height / 2) - modalRect.top; targetX = rowRect.left + rowRect.width - 30 - modalRect.left; /* Target score cell */ }
                else { const tableRect = aiLeaderboardBody.getBoundingClientRect(); targetY = tableRect.top + 20 - modalRect.top; targetX = tableRect.right - 50 - modalRect.left; }
                const startRect = judgeResultScore.getBoundingClientRect(); const startY = startRect.top + (startRect.height / 2) - modalRect.top; const startX = startRect.left + (startRect.width / 2) - modalRect.left;
                flyingScoreElement.textContent = `${score.toFixed(1)}`; flyingScoreElement.style.position = 'absolute'; flyingScoreElement.style.top = `${startY}px`; flyingScoreElement.style.left = `${startX}px`; flyingScoreElement.style.opacity = '1'; flyingScoreElement.style.transform = 'scale(1)'; judgeModalElement.querySelector('.modal-dialog .modal-content .modal-body').appendChild(flyingScoreElement); // Append relative to body
                requestAnimationFrame(() => { flyingScoreElement.style.top = `${targetY}px`; flyingScoreElement.style.left = `${targetX}px`; flyingScoreElement.style.opacity = '0'; flyingScoreElement.style.transform = 'scale(0.3)'; });
                flyingScoreElement.addEventListener('transitionend', () => { flyingScoreElement.remove(); updateAiJudgeModal(); }, { once: true }); // Re-render leaderboard after animation
            }

             if (judgeProjectBtn) {
                 judgeProjectBtn.addEventListener('click', async function() {
                     const selectedTeam = judgeTeamSelect.value;
                     if (!selectedTeam) { /* (Keep existing error display logic) */ judgeResultTeamName.textContent = "Error"; judgeResultAnalysisList.innerHTML = '<li class="visible feedback-error">Please select a team first.</li>'; judgeResultScore.innerHTML = ''; return; }
                     judgeResultsArea.style.display = 'none'; judgeLoader.style.display = 'block'; judgeProjectBtn.disabled = true; judgeTeamSelect.disabled = true;
                     try {
                         const { score, analysisPoints } = await runJudgeSimulation(selectedTeam);
                         judgeLoader.style.display = 'none'; judgeResultsArea.style.display = 'block'; judgeResultTeamName.textContent = `Evaluation: ${selectedTeam}`;
                         const displayTime = displayAnalysisSequentially(analysisPoints);
                         setTimeout(() => {
                             judgeResultScore.innerHTML = `Score: <span>${score.toFixed(1)} / 10.0</span>`;
                             // Animate score AFTER analysis text is done
                             setTimeout(() => { animateScoreToLeaderboard(selectedTeam, score); }, 150);
                             judgeProjectBtn.disabled = false; judgeTeamSelect.disabled = false;
                         }, displayTime + 100);
                     } catch (error) {
                         console.error("Judging Error:", error);
                         judgeLoader.style.display = 'none'; judgeResultsArea.style.display = 'block';
                         judgeResultTeamName.textContent = "Error"; judgeResultAnalysisList.innerHTML = `<li class="visible feedback-error">${error.message || 'Judging failed.'}</li>`; judgeResultScore.innerHTML = '';
                         judgeProjectBtn.disabled = false; judgeTeamSelect.disabled = false;
                     }
                 });

                 // Render AI Judge board on modal show
                 judgeModalElement.addEventListener('show.bs.modal', () => {
                     updateAiJudgeModal(); // Ensure dropdown & leaderboard are up-to-date
                 });
                 // Clear results when modal is hidden
                 judgeModalElement.addEventListener('hidden.bs.modal', () => {
                    judgeResultsArea.style.display = 'none'; judgeLoader.style.display = 'none';
                    judgeTeamSelect.selectedIndex = 0; // Reset dropdown
                });
            } else { console.error("AI Judging elements not found."); }

            // --- Profile Modal Logic (Adapted Reset) ---
            async function getPointsLeaderboardData() { /* (Keep existing logic using POINTS_LEADERBOARD_KEY) */
                 return new Promise((resolve) => {
                     if (tg?.CloudStorage) {
                         tg.CloudStorage.getItem(POINTS_LEADERBOARD_KEY, (error, value) => {
                             let data = []; if (error) console.error(`CS Error loading ${POINTS_LEADERBOARD_KEY}:`, error);
                             else if (value) { try { data = JSON.parse(value); if (!Array.isArray(data)) data = []; } catch (e) { data = []; } }
                             if (currentUser) { const userExists = data.some(e => e.userId === currentUser.id); if (!userExists) { data.push({ userId: currentUser.id, firstName: currentUser.first_name || 'Player', points: totalWellyPoints }); } } resolve(data);
                         });
                     } else { resolve(currentUser ? [{ userId: currentUser.id, firstName: currentUser.first_name || 'Player', points: totalWellyPoints }] : []); }
                 });
            }
            async function savePointsLeaderboardData(data) { /* (Keep existing logic using POINTS_LEADERBOARD_KEY) */
                 if (!Array.isArray(data) || !tg?.CloudStorage) return false;
                 return new Promise((resolve) => { tg.CloudStorage.setItem(POINTS_LEADERBOARD_KEY, JSON.stringify(data), (error, success) => { if (error) { console.error(`CS Error saving ${POINTS_LEADERBOARD_KEY}:`, error); resolve(false); } else { resolve(success); } }); });
            }
            async function updatePointsLeaderboardWithCurrentUser(currentPoints) { /* (Keep existing logic) */
                if (!currentUser) return; try { let leaderboard = await getPointsLeaderboardData(); const userIndex = leaderboard.findIndex(e => e.userId === currentUser.id); let changed = false; const userName = currentUser.first_name || 'Player'; if (userIndex > -1) { if (leaderboard[userIndex].points !== currentPoints || leaderboard[userIndex].firstName !== userName) { leaderboard[userIndex].points = currentPoints; leaderboard[userIndex].firstName = userName; changed = true; } } else { leaderboard.push({ userId: currentUser.id, firstName: userName, points: currentPoints }); changed = true; } if (changed) { leaderboard.sort((a, b) => b.points - a.points); await savePointsLeaderboardData(leaderboard); } } catch (error) { console.error("Failed to update points leaderboard:", error); }
            }
            async function fetchAndDisplayPointsLeaderboard() { /* (Keep existing display logic) */
                if (!profileLeaderboardTableBody || !profileRankDisplay || !profileLeaderboardLoading || !profileLeaderboardEmpty) return;
                if (!currentUser) { profileRankDisplay.textContent = 'Rank: N/A (Guest)'; profileLeaderboardEmpty.textContent = 'Login to see leaderboard.'; profileLeaderboardEmpty.style.display = 'block'; profileLeaderboardLoading.style.display = 'none'; profileLeaderboardTable.style.display = 'none'; return; }
                profileLeaderboardLoading.style.display = 'block'; profileLeaderboardTableBody.innerHTML = ''; profileLeaderboardEmpty.style.display = 'none'; profileLeaderboardTable.style.display = 'table'; profileRankDisplay.textContent = 'Rank: Calculating...';
                try { await loadWellyPoints(); const currentPoints = totalWellyPoints; let leaderboard = await getPointsLeaderboardData(); const userIndex = leaderboard.findIndex(e => e.userId === currentUser.id); if (userIndex > -1 && leaderboard[userIndex].points !== currentPoints) { leaderboard[userIndex].points = currentPoints; leaderboard.sort((a, b) => b.points - a.points); } else if (userIndex === -1) { leaderboard.push({ userId: currentUser.id, firstName: currentUser.first_name || 'Player', points: currentPoints }); leaderboard.sort((a, b) => b.points - a.points); } if (leaderboard.length === 0) { profileRankDisplay.textContent = 'Rank: N/A'; profileLeaderboardEmpty.textContent = 'Leaderboard empty.'; profileLeaderboardEmpty.style.display = 'block'; profileLeaderboardTable.style.display = 'none'; } else { const userRank = leaderboard.findIndex(e => e.userId === currentUser.id) + 1; const totalPlayers = leaderboard.length; profileRankDisplay.textContent = `Your Rank: #${userRank} of ${totalPlayers}`; const topN = 5; leaderboard.slice(0, topN).forEach((entry, index) => { const rank = index + 1; const isCurrentUser = entry.userId === currentUser.id; const row = profileLeaderboardTableBody.insertRow(); row.innerHTML = `<td class="text-center"><span class="rank-badge">${rank}</span></td><td>${entry.firstName || 'Player'} ${isCurrentUser ? '<small class="text-muted fst-italic">(You)</small>' : ''}</td><td class="points-cell">${entry.points}</td>`; if (isCurrentUser) row.classList.add('table-info'); }); profileLeaderboardTable.style.display = 'table'; } profileLeaderboardLoading.style.display = 'none'; } catch (error) { console.error("Error fetching/displaying points leaderboard:", error); profileRankDisplay.textContent = 'Rank: Error'; profileLeaderboardEmpty.textContent = 'Error loading leaderboard.'; profileLeaderboardEmpty.style.display = 'block'; profileLeaderboardLoading.style.display = 'none'; profileLeaderboardTable.style.display = 'none'; }
            }

            // Profile Modal Event Listener
            if (profileModalElement) {
                profileModalElement.addEventListener('show.bs.modal', async function () {
                    if (!currentUser) { const modalInstance = bootstrap.Modal.getInstance(profileModalElement); if (modalInstance) modalInstance.hide(); return; }
                    updateUserProfileDisplay(); // Update basic info + team status
                    if (resetFeedbackArea) resetFeedbackArea.textContent = '';
                    if (resetProgressBtn) resetProgressBtn.disabled = false;
                    await fetchAndDisplayPointsLeaderboard(); // Fetch and display points leaderboard
                    // Optionally background update points LB data
                     updatePointsLeaderboardWithCurrentUser(totalWellyPoints);
                });
            }

            // MODIFIED Reset Progress Button Listener
             if (resetProgressBtn && currentUser) {
                 resetProgressBtn.addEventListener('click', function() {
                     if(resetFeedbackArea) resetFeedbackArea.textContent = '';
                     if (!tg?.showConfirm) {
                         alert("This action requires confirmation within the Telegram app.");
                         return;
                     }

                     tg.showConfirm("Reset ALL your Points, Tasks, AND Team Registration?\nThis cannot be undone.", async (confirmed) => {
                         if (confirmed) {
                             console.log("User confirmed full reset.");
                             resetProgressBtn.disabled = true;
                             setResetFeedback('Resetting...', 'info');

                             try {
                                 // 1. Reset Points
                                 totalWellyPoints = 0;
                                 await saveWellyPoints();

                                 // 2. Reset Tasks
                                 taskState = {};
                                 saveTaskState(taskState); // Saves to CS and LS

                                 // 3. Reset User's Points on Leaderboard
                                 await updatePointsLeaderboardWithCurrentUser(0);

                                 // 4. Remove User from Team in hackathonTeamsData
                                 let teamDataModified = false;
                                 if (userRegisteredTeam && hackathonTeamsData[userRegisteredTeam]) {
                                     const initialMemberCount = hackathonTeamsData[userRegisteredTeam].members.length;
                                     hackathonTeamsData[userRegisteredTeam].members = hackathonTeamsData[userRegisteredTeam].members.filter(m => m.id !== currentUser.id);
                                      // Optional: Delete team if it becomes empty? Maybe not, keep structure.
                                     if (hackathonTeamsData[userRegisteredTeam].members.length < initialMemberCount) {
                                         teamDataModified = true;
                                         console.log(`Removed user ${currentUser.id} from team ${userRegisteredTeam}`);
                                     }
                                 }

                                 // 5. Save Modified Team Data (if changed)
                                 if (teamDataModified) {
                                     await saveHackathonTeams();
                                 }

                                 // 6. Remove User's Specific Registration Link Key
                                 await removeUserRegistration(); // Sets userRegisteredTeam to null

                                 // --- Update UI ---
                                 updateUserProfileDisplay(); // Update header, profile modal team display
                                 initializeTaskUI(); // Update task UI in checklist
                                 updateProgressBar(); // Update progress bar
                                 updateRegistrationButtonState(); // Update main registration button
                                 updateAiJudgeModal(); // Update AI judge list (user removed from team)
                                 await fetchAndDisplayPointsLeaderboard(); // Refresh leaderboard in profile modal

                                 setResetFeedback('Reset Complete!', 'success');
                                 tg?.showAlert("Your points, tasks, and registration have been reset.");

                             } catch (error) {
                                 console.error("Error during full reset:", error);
                                 setResetFeedback(`Reset failed: ${error.message || 'Unknown error'}`, 'error');
                                 tg?.showAlert(`An error occurred during reset: ${error.message || error}`);
                                 // Don't re-enable button immediately on failure, user might need to retry or contact support
                                 // Reload state to be safe?
                                 await loadWellyPoints(); await loadTaskState(); await loadHackathonTeams(); await checkUserRegistration();
                                 // Update UI again after reload
                                 updateUserProfileDisplay(); initializeTaskUI(); updateProgressBar(); updateRegistrationButtonState(); updateAiJudgeModal();
                             } finally {
                                // Optionally re-enable button after a delay or keep disabled
                                setTimeout(() => { if (resetProgressBtn) resetProgressBtn.disabled = false; }, 2000);
                             }
                         } else {
                             console.log("User cancelled reset.");
                             setResetFeedback('Reset cancelled.', 'warning');
                         }
                     });
                 });
             } else if (resetProgressBtn) {
                 resetProgressBtn.disabled = true; // Ensure disabled for guests
             }

             function setResetFeedback(message, type) {
                 if (resetFeedbackArea) {
                    resetFeedbackArea.textContent = message;
                    resetFeedbackArea.className = `small d-block mt-1 feedback-${type}`;
                 }
             }
            // --- END Profile Modal Logic ---

            // --- Smooth Scroll Logic (Keep existing) ---
            document.querySelectorAll('a[href^="#"]').forEach(link => { /* (Keep existing) */ });


            // --- Final Initializations ---
            initializeTelegramApp();
            setupLogoScroll();

        });
    </script>

</body>
</html>
